<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROINVENTORY</title>
    
    <!-- Favicon å›¾æ ‡ -->
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/favicon-512.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icons/favicon-512.png">
    
    <!-- å¾®ä¿¡åˆ†äº«å’Œ Open Graph æ ‡ç­¾ -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="PROINVENTORY">
    <meta property="og:description" content="ä¸“ä¸šçš„åº“å­˜ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒç‰©å“ç®¡ç†ã€å‡ºå…¥åº“è®°å½•ã€é¢„å‡ºåº“æ–¹æ¡ˆå’Œç‰©å“è¿½æº¯åŠŸèƒ½">
    <meta property="og:image" content="/icons/favicon-512.png">
    <meta property="og:url" content="">
    <meta property="og:site_name" content="PROINVENTORY">
    
    <!-- å¾®ä¿¡ä¸“ç”¨æ ‡ç­¾ -->
    <meta name="description" content="ä¸“ä¸šçš„åº“å­˜ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒç‰©å“ç®¡ç†ã€å‡ºå…¥åº“è®°å½•ã€é¢„å‡ºåº“æ–¹æ¡ˆå’Œç‰©å“è¿½æº¯åŠŸèƒ½">
    
    <!-- Twitter Card æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰ -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="PROINVENTORY">
    <meta name="twitter:description" content="ä¸“ä¸šçš„åº“å­˜ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒç‰©å“ç®¡ç†ã€å‡ºå…¥åº“è®°å½•ã€é¢„å‡ºåº“æ–¹æ¡ˆå’Œç‰©å“è¿½æº¯åŠŸèƒ½">
    <meta name="twitter:image" content="/icons/favicon-512.png">
    <script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
    <!-- æ¡å½¢ç ç”Ÿæˆåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- å¦‚æœå­˜åœ¨ config.jsï¼Œåˆ™åŠ è½½å®ƒæ¥è®¾ç½®é…ç½® -->
    <script src="config.js" onerror="console.log('config.js ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e1e8ed;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 24px 30px;
            text-align: left;
            border-bottom: 3px solid #3498db;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .header h1 {
            font-size: 1.6em;
            margin: 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .app-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 6px;
            font-size: 0.55em;
            font-weight: 700;
            color: #0b5ed7;
            background: #e7f1ff;
            border: 1px solid #b6d4fe;
            border-radius: 6px;
            vertical-align: middle;
        }

        .theme-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            user-select: none;
            font-size: 0.9em;
        }
        .theme-toggle input {
            display: none;
        }
        .theme-toggle .knob {
            width: 34px;
            height: 18px;
            border-radius: 10px;
            background: #adb5bd;
            position: relative;
            transition: background 0.2s ease;
        }
        .theme-toggle .knob::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #fff;
            transition: transform 0.2s ease;
        }
        .theme-toggle input:checked + .knob {
            background: #3498db;
        }
        .theme-toggle input:checked + .knob::after {
            transform: translateX(16px);
        }

        /* æš—è‰²ä¸»é¢˜è¦†ç›– */
        .dark-theme body,
        body.dark-theme {
            background: #111418 !important;
            color: #e9ecef !important;
        }
        body.dark-theme .container {
            background: #161a1e !important;
            border-color: #262c33 !important;
            box-shadow: 0 1px 6px rgba(0,0,0,0.5) !important;
        }
        body.dark-theme .status-bar,
        body.dark-theme .tabs {
            background: #1b2026 !important;
            border-color: #2a313a !important;
        }
        body.dark-theme .tab {
            color: #aeb6bf !important;
        }
        body.dark-theme .tab.active {
            color: #e9ecef !important;
            background: #161a1e !important;
        }
        body.dark-theme .data-table,
        body.dark-theme .items-list table {
            background: #161a1e !important;
            border-color: #2a313a !important;
        }
        body.dark-theme .data-table thead {
            background: #0f1419 !important;
        }
        body.dark-theme .data-table td,
        body.dark-theme .items-list td {
            border-color: #2a313a !important;
            color: #dfe6ee !important;
        }
        body.dark-theme .item-card,
        body.dark-theme .stat-card,
        body.dark-theme .stat-group,
        body.dark-theme .stat-group-details {
            background: #161a1e !important;
            border-color: #2a313a !important;
            color: #e9ecef !important;
        }
        body.dark-theme .view-btn {
            background: #1b2026 !important;
            border-color: #2a313a !important;
            color: #cfd7df !important;
        }
        body.dark-theme .view-btn.active {
            background: #2d74b8 !important;
            border-color: #2d74b8 !important;
            color: #fff !important;
        }
        body.dark-theme .modal-content {
            background: #161a1e !important;
            color: #e9ecef !important;
        }
        body.dark-theme .items-list th {
            background: #1b2026 !important;
            color: #cfd7df !important;
            border-color: #2a313a !important;
        }
        body.dark-theme .notice-bar {
            background: #1b2026 !important;
            border-top-color: #2a313a !important;
            border-bottom-color: #2a313a !important;
        }
        body.dark-theme .notice-badge {
            background: #2a313a !important;
            color: #e9ecef !important;
        }
        body.dark-theme .app-badge {
            color: #91c2ff !important;
            background: #0d1b2a !important;
            border-color: #2a313a !important;
        }
        /* æš—è‰²ä¸‹å°†å„ç±»â€œç°å­—â€ç»Ÿä¸€æäº®ä¸ºç™½/è¿‘ç™½ */
        body.dark-theme .detail-label,
        body.dark-theme .detail-value,
        body.dark-theme .notice-title,
        body.dark-theme .notice-time,
        body.dark-theme .status-bar,
        body.dark-theme .status-bar span,
        body.dark-theme .barcode-text,
        body.dark-theme .tab,
        body.dark-theme .tab.active,
        body.dark-theme .item-title,
        body.dark-theme .detail-item,
        body.dark-theme .detail-section h3,
        body.dark-theme .stat-card p,
        body.dark-theme .stat-card h3,
        body.dark-theme .expand-icon,
        body.dark-theme .view-toggle,
        body.dark-theme .view-toggle .view-btn,
        body.dark-theme .loading,
        body.dark-theme .empty-state,
        body.dark-theme .data-table thead,
        body.dark-theme .data-table thead th,
        body.dark-theme .items-list th {
            color: #e9ecef !important;
        }
        body.dark-theme .error {
            background: #3a1e22 !important;
            color: #ffecec !important;
            border-left-color: #d46a6a !important;
        }
        /* è¡¨å•ä¸æŒ‰é’®åœ¨æš—è‰²ä¸‹çš„å¯è¯»æ€§ */
        body.dark-theme .search-box,
        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background: #1b2026 !important;
            color: #e9ecef !important;
            border-color: #2a313a !important;
        }
        body.dark-theme .search-box::placeholder,
        body.dark-theme input::placeholder,
        body.dark-theme textarea::placeholder {
            color: #cfd7df !important;
        }
        body.dark-theme .filter-btn,
        body.dark-theme .refresh-btn {
            color: #ffffff !important;
            border-color: #2a313a !important;
        }
        /* è¡¨æ ¼æ¬¡è¦æ–‡å­—é¢œè‰²æäº® */
        body.dark-theme .stat-group-title,
        body.dark-theme .stat-group-count {
            color: #e9ecef !important;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
        }

        /* å…¬å‘Šæ æ ·å¼ */
        .notice-bar {
            background: #fffbea;
            border-bottom: 1px solid #ffe8a1;
            border-top: 1px solid #ffe8a1;
            padding: 10px 30px;
        }
        .notice-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 20px;
        }
        .notice-item {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .notice-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
            color: #856404;
            background: #ffe8a1;
            white-space: nowrap;
        }
        .notice-title {
            font-weight: 600;
            color: #7a5d00;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .notice-time {
            margin-left: auto;
            font-size: 0.85em;
            color: #8a6d3b;
            white-space: nowrap;
        }
        @media (max-width: 768px) {
            .notice-list {
                grid-template-columns: 1fr;
            }
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 1.1em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
            position: relative;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            color: #2c3e50;
            background: white;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #3498db;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #3498db;
        }

        .filter-btn {
            padding: 10px 20px;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background 0.2s;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #2c3e50;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background 0.2s;
            font-weight: 500;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #ffffff;
            color: #2c3e50;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e1e8ed;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #3498db;
            font-weight: 600;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .stat-card.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stat-card.clickable:hover {
            background: #f8f9fa;
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(52, 152, 219, 0.2);
        }

        .stat-card.clickable.active {
            background: #e7f1ff;
            border-color: #3498db;
            border-width: 2px;
        }

        body.dark-theme .stat-card.clickable:hover {
            background: #2a313a;
        }

        body.dark-theme .stat-card.clickable.active {
            background: #1e3a5f;
            border-color: #3498db;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
        }

        .barcode-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        /* é€šç”¨æ¡ç å®¹å™¨ï¼ˆåº“å­˜è¡¨æ ¼ç”¨ï¼‰ */
        .barcode-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .barcode-svg {
            max-width: 150px;
            height: auto;
        }

        .barcode-image {
            max-width: 150px;
            height: auto;
            image-rendering: crisp-edges;
        }

        .barcode-text {
            font-size: 0.75em;
            color: #000000;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .data-table thead {
            background: #34495e;
            color: white;
        }

        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-inStock {
            background: #d4edda;
            color: #155724;
        }

        .status-outStock {
            background: #fff3cd;
            color: #856404;
        }

        .status-damaged {
            background: #f8d7da;
            color: #721c24;
        }

        .type-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .type-stockIn {
            background: #d1ecf1;
            color: #0c5460;
        }

        .type-stockOut {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar-container {
            width: 100%;
            max-width: 500px;
            margin: 50px auto;
            background: #e9ecef;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            height: 40px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9, #3498db);
            background-size: 200% 100%;
            animation: progress-animation 2s linear infinite;
            border-radius: 20px;
            position: relative;
            width: 100%;
        }

        .progress-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-weight: 600;
            font-size: 0.95em;
            white-space: nowrap;
            z-index: 10;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        @keyframes progress-animation {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 200% 0%;
            }
        }

        body.dark-theme .progress-bar-container {
            background: #2a313a;
        }

        body.dark-theme .progress-bar {
            background: linear-gradient(90deg, #3498db, #2980b9, #3498db);
            background-size: 200% 100%;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* ç»Ÿè®¡ä¿¡æ¯æŠ˜å å¼€å…³ï¼ˆæ‰‹æœºç«¯ï¼‰ */
        .stats-toggle {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            cursor: pointer;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e8ed;
            font-size: 0.9em;
            color: #495057;
        }
        .stats-toggle-label {
            font-weight: 500;
        }
        .stats-toggle-arrow {
            font-size: 0.8em;
            color: #6c757d;
        }

        body.dark-theme .stats-toggle {
            background: #2a313a;
            border-bottom-color: #3a414a;
            color: #e9ecef;
        }

        body.dark-theme .stats-toggle-label {
            color: #e9ecef;
        }

        body.dark-theme .stats-toggle-arrow {
            color: #adb5bd;
        }

        .item-list {
            display: grid;
            gap: 15px;
        }

        .item-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .item-card:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }

        .data-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .data-table tbody tr:hover {
            background: #f0f7ff !important;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #212529;
        }

        .item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1em;
            color: #212529;
            font-weight: 500;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: #2c3e50;
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e8ed;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .items-list {
            margin-top: 15px;
        }

        .items-list table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .items-list th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e1e8ed;
        }

        .items-list td {
            padding: 10px;
            border-bottom: 1px solid #e1e8ed;
        }

        .items-list tr:hover {
            background: #f8f9fa;
        }

        /* è§†å›¾åˆ‡æ¢æŒ‰é’® */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
        }

        .view-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #e1e8ed;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s;
        }

        .view-btn:hover {
            background: #e9ecef;
            border-color: #3498db;
        }

        .view-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* ç»Ÿè®¡è§†å›¾æ ·å¼ */
        .statistics-view {
            margin-top: 15px;
        }

        .stat-group {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .stat-group-header {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .stat-group-header:hover {
            background: #e9ecef;
        }

        .stat-group-title {
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
        }

        .stat-group-count {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
        }

        .stat-group-details {
            display: none;
            padding: 15px;
            background: white;
            border-top: 1px solid #e1e8ed;
        }

        .stat-group-details.expanded {
            display: block;
        }

        .stat-group-items {
            font-size: 0.9em;
        }

        .stat-group-items table {
            width: 100%;
            font-size: 0.95em;
        }

        .stat-group-items th {
            background: #f8f9fa;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            color: #6c757d;
            font-size: 0.85em;
        }

        .stat-group-items td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .expand-icon {
            color: #6c757d;
            font-weight: bold;
            margin-left: 10px;
            transition: transform 0.2s;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                border-radius: 6px;
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            }

            .header {
                padding: 16px 18px;
            }

            .header h1 {
                font-size: 1.4em;
            }
            /* ç¼©å°ä¸»é¢˜åˆ‡æ¢å°ºå¯¸ï¼ˆå¹³æ¿åŠä»¥ä¸‹ï¼‰ */
            .theme-toggle {
                padding: 5px 10px;
                font-size: 0.85em;
            }
            .theme-toggle .knob {
                width: 30px;
                height: 16px;
            }
            .theme-toggle .knob::after {
                width: 12px;
                height: 12px;
            }
            .theme-toggle input:checked + .knob::after {
                transform: translateX(14px);
            }

            .status-bar {
                padding: 10px 15px;
                flex-wrap: wrap;
                gap: 8px;
            }

            /* æ ‡ç­¾æ ï¼šå››ç­‰åˆ†æ …æ ¼ï¼Œé¿å…æº¢å‡ºä¸”ä¸éœ€è¦æ»šåŠ¨ */
            .tabs {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                overflow: visible;
                white-space: normal;
            }

            .tab {
                padding: 8px 10px;
                font-size: 0.9em;
                width: 100%;
                flex: initial;
                white-space: nowrap;          /* é˜²æ­¢æŒ‰é’®å†…æ–‡å­—æ¢è¡Œ */
                word-break: keep-all;         /* ä¿æŒä¸­æ–‡è¯ç»„ä¸æ‹†åˆ† */
            }

            .tab-content {
                padding: 15px;
            }

            .controls {
                gap: 10px;
                margin-bottom: 15px;
            }

            .search-box {
                min-width: 160px;
                padding: 10px 14px;
                font-size: 0.95em;
            }

            .filter-btn,
            .refresh-btn {
                padding: 8px 12px;
                font-size: 0.9em;
                border-radius: 4px;
            }

            .stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
                margin-bottom: 18px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-card h3 {
                font-size: 1.6em;
                margin-bottom: 6px;
            }

            .stat-card p {
                font-size: 0.95em;
            }

            .data-table {
                font-size: 0.9em;
                table-layout: fixed;
                width: 100%;
            }

            .data-table th,
            .data-table td {
                padding: 6px 8px;
            }

            .item-list {
                gap: 10px;
            }

            .item-card {
                padding: 12px;
                border-radius: 8px;
            }

            .item-header {
                margin-bottom: 10px;
            }

            .item-title {
                font-size: 1.1em;
            }

            .item-details {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 8px;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .modal-body {
                padding: 20px;
            }

            .detail-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
            }

            .view-toggle {
                gap: 8px;
                margin-bottom: 12px;
                padding-bottom: 12px;
            }

            .view-btn {
                padding: 6px 10px;
                font-size: 0.85em;
            }

            .stat-group-header {
                padding: 10px 12px;
            }

            .stat-group-count {
                padding: 3px 10px;
                font-size: 0.8em;
            }

            .stat-group-items table {
                font-size: 0.9em;
            }

            /* æ¨¡æ€æ¡†æ ‡é¢˜ä¸æ­£æ–‡æ›´å° */
            .modal-header {
                padding: 12px 20px;
            }
            .modal-header h2 {
                font-size: 1.2em;
            }
            .modal-body {
                font-size: 0.95em;
            }
            .modal-body .detail-label {
                font-size: 0.85em;
            }
            .modal-body .detail-value {
                font-size: 1.02em;
            }
        }

        /* è¶…å°å±æ‰‹æœºæ›´ç´§å‡‘å¸ƒå±€ */
        @media (max-width: 576px) {
            body {
                padding: 6px;
            }
            /* æ‰‹æœºç«¯è¿›ä¸€æ­¥ç¼©å°ä¸»é¢˜åˆ‡æ¢å°ºå¯¸ */
            .theme-toggle {
                padding: 4px 8px;
                font-size: 0.7em;
            }
            .theme-toggle .knob {
                width: 28px;
                height: 14px;
            }
            .theme-toggle .knob::after {
                width: 10px;
                height: 10px;
            }
            .theme-toggle input:checked + .knob::after {
                transform: translateX(14px);
            }
            /* æ‰‹æœºç«¯ç™»å‡ºæŒ‰é’®ç¼©å°ï¼Œå­—å·ä¸ä¸»é¢˜åˆ‡æ¢ä¸€è‡´ */
            .logout-btn {
                font-size: 0.7em !important;
                padding: 2px 5px !important;
            }
            /* æ‰‹æœºç«¯ç™»å‡ºæŒ‰é’®å’Œä¸»é¢˜åˆ‡æ¢æŒ‰é’®ä¹‹é—´çš„é—´è·å‡å° */
            .header > div {
                gap: 4px !important;
            }
            /* å…¬å‘Šæ å·¦è¾¹è·å†ç¼©å°ä¸€ä¸ªä¸­æ–‡å­—ç¬¦å·¦å³ */
            .notice-bar {
                padding: 10px 14px;
            }
            /* æ‰‹æœºç«¯ï¼šè®©è®°å½•ä¿¡æ¯é‡Œçš„â€œè®°å½•ç¼–å·â€å•ç‹¬å ä¸€è¡Œ */
            .detail-grid .full-row-mobile {
                grid-column: 1 / -1;
            }
            /* æ‰‹æœºç«¯åˆ—è¡¨ä»…æ˜¾ç¤ºæ¡ç æ•°å­—ï¼Œéšè—æ¡ç å›¾ç‰‡ */
            .barcode-svg {
                display: none;
            }
            /* æ ‡ç­¾æ ï¼šå››ç­‰åˆ†æ›´ç´§å‡‘ */
            .tabs {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
                overflow: visible;
                white-space: normal;
            }
            .tab {
                width: 100%;
                padding: 5px 6px;
                font-size: 0.8em;
                flex: initial;
                white-space: nowrap;          /* é˜²æ­¢æŒ‰é’®å†…æ–‡å­—æ¢è¡Œ */
                word-break: keep-all;         /* ä¿æŒä¸­æ–‡è¯ç»„ä¸æ‹†åˆ† */
            }
            /* åº“å­˜è¡¨ï¼šå›ºå®šå¸ƒå±€ä¸åˆ—å®½ï¼Œé˜²çŠ¶æ€æº¢å‡º */
            #inventory .data-table {
                table-layout: auto; /* è®©åˆ—å®½è‡ªé€‚åº”å†…å®¹ï¼Œæ¡ç åˆ—ä¸å†å›ºå®šè¿‡å®½ */
                width: 100%;
            }
            /* æ¡ç åˆ—æ”¹ä¸ºè‡ªé€‚åº” */
            #inventory .data-table th:nth-child(1),
            #inventory .data-table td:nth-child(1) { width: auto !important; }
            #inventory .data-table th:nth-child(3),
            #inventory .data-table td:nth-child(3) { width: 22%; }
            #inventory .data-table th:nth-child(4),
            #inventory .data-table td:nth-child(4) { width: 22%; }
            #inventory .data-table th:nth-child(5),
            #inventory .data-table td:nth-child(5) { width: 20%; }
            .status-badge {
                padding: 3px 10px;
                border-radius: 14px;
                font-size: 0.8em;
            }

            .header {
                padding: 12px 14px;
            }

            .header h1 {
                font-size: 1.2em;
            }

            .status-bar {
                padding: 8px 12px;
                gap: 6px;
            }

            /* ç»Ÿè®¡ä¿¡æ¯ï¼šæ‰‹æœºç«¯é»˜è®¤æŠ˜å ï¼Œé€šè¿‡å¼€å…³å±•å¼€ */
            .stats-toggle {
                display: flex;
            }
            .stats.collapsible {
                display: none;
            }
            .stats.collapsible.expanded {
                display: grid;
            }

            .tab {
                padding: 10px;
                font-size: 0.95em;
            }

            .tab-content {
                padding: 12px;
            }

            .controls {
                gap: 8px;
                margin-bottom: 12px;
            }

            .search-box {
                padding: 8px 12px;
                font-size: 0.9em;
            }

            .filter-btn,
            .refresh-btn {
                padding: 6px 10px;
                font-size: 0.85em;
            }

            /* è¡¨æ ¼æ›´ç´§å‡‘ï¼Œå¹¶éšè—éå…³é”®åˆ—ï¼ˆ2=åç§°ï¼Œ6=ä½ç½®ï¼Œ7=å¤‡æ³¨ï¼‰ */
            .data-table {
                font-size: 0.85em;
            }

            .data-table th,
            .data-table td {
                padding: 6px 8px;
                max-width: 140px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* éšè—åç§°ï¼ˆç¬¬2åˆ—ï¼‰ï¼Œä¿ç•™æ¡ç (1)ã€å“ç‰Œ(3)ã€å‹å·(4)ã€çŠ¶æ€(5) */
            .data-table th:nth-child(2),
            .data-table td:nth-child(2),
            .data-table th:nth-child(6),
            .data-table td:nth-child(6),
            .data-table th:nth-child(7),
            .data-table td:nth-child(7) {
                display: none;
            }

            /* ç»Ÿè®¡å¡ç‰‡æ›´ç´§å‡‘ */
            .stats {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                margin-bottom: 12px;
            }

            /* å‡ºå…¥åº“ç»Ÿè®¡ï¼š3ä¸ªå¡ç‰‡å¹³å‡åˆ†å¸ƒå æ»¡ä¸€è¡Œ */
            #stockStats.stats {
                grid-template-columns: repeat(3, 1fr);
            }

            /* é¢„å‡ºåº“æ–¹æ¡ˆç»Ÿè®¡ï¼š1ä¸ªå¡ç‰‡å æ»¡ä¸€è¡Œ */
            #preOutboundStats.stats {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 8px 4px;
            }

            .stat-card h3 {
                font-size: 1.2em;
                margin-bottom: 2px;
            }

            .stat-card p {
                font-size: 0.75em;
            }

            /* è¿›åº¦æ¡ç§»åŠ¨ç«¯æ ·å¼ */
            .progress-bar-container {
                max-width: 100%;
                margin: 30px auto;
                height: 35px;
            }

            .progress-bar-text {
                font-size: 0.85em;
            }

            /* å¡ç‰‡åˆ—è¡¨æ›´ç´§å‡‘ */
            .item-list {
                gap: 8px;
            }

            .item-card {
                padding: 10px;
            }

            .item-title {
                font-size: 1em;
            }

            .item-details {
                grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
                gap: 4px;
                row-gap: 6px;
            }

            .detail-grid {
                grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
                gap: 6px;
            }

            .view-btn {
                padding: 5px 7px;
                font-size: 0.78em;
            }

            .modal-content {
                width: 96%;
                margin: 12% auto;
            }

            .modal-body {
                padding: 14px;
            }

            /* å‡ºå…¥åº“è®°å½•ä¸é¢„å‡ºåº“å¡ç‰‡å†…æ–‡å­—æ›´å° */
            #stockRecords .item-card .detail-label,
            #preOutbound .item-card .detail-label {
                font-size: 0.8em;
            }
            #stockRecords .item-card .detail-value,
            #preOutbound .item-card .detail-value {
                font-size: 0.95em;
            }

            /* æ¨¡æ€æ¡†å†…çš„è¯¦æƒ…å­—å·æ›´å° */
            .modal-body .detail-label {
                font-size: 0.78em;
            }
            .modal-body .detail-value {
                font-size: 0.92em;
            }
            .modal-body h3 {
                font-size: 0.95em;
                margin-bottom: 8px;
            }

            /* æ¨¡æ€æ¡†æ ‡é¢˜ä¸æ­£æ–‡æ›´è¿›ä¸€æ­¥ç¼©å° */
            .modal-header {
                padding: 10px 15px;
            }
            .modal-header h2 {
                font-size: 1.05em;
            }
            .modal-body {
                font-size: 0.9em;
            }
        }

        /* ç™»å½•ç•Œé¢ç§»åŠ¨ç«¯å“åº”å¼ */
        @media (max-width: 576px) {
            .login-box {
                padding: 30px 20px;
            }
            .login-box h2 {
                font-size: 1.3em;
                margin-bottom: 25px;
                white-space: nowrap;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-wrap: nowrap;
            }
            .login-box .app-badge {
                font-size: 0.5em;
                padding: 1px 4px;
                margin-left: 6px;
            }
            .logout-btn {
                font-size: 0.7em;
                padding: 2px 5px;
            }
            .theme-toggle {
                padding: 3px 6px;
                font-size: 0.7em;
                gap: 4px;
            }
            .theme-toggle .knob {
                width: 24px;
                height: 12px;
            }
            .theme-toggle .knob::after {
                width: 8px;
                height: 8px;
                top: 2px;
                left: 2px;
            }
            .theme-toggle input:checked + .knob::after {
                transform: translateX(12px);
            }
        }

        /* ç™»å½•ç•Œé¢æ ·å¼ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            max-height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        body {
            overflow: hidden;
        }
        
        body.logged-in {
            overflow: auto;
        }

        .login-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 1.8em;
            white-space: nowrap;
        }
        
        .login-box .app-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 6px;
            font-size: 0.55em;
            font-weight: 700;
            color: #0b5ed7;
            background: #e7f1ff;
            border: 1px solid #b6d4fe;
            border-radius: 6px;
            vertical-align: middle;
        }

        .login-form-group {
            margin-bottom: 20px;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        .login-form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .login-form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: #2980b9;
        }

        .login-error {
            color: #dc3545;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            min-height: 20px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 12px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        #appleSignInBtnLogin {
            transition: background 0.3s, transform 0.2s;
        }

        #appleSignInBtnLogin:hover {
            background: #333 !important;
            transform: translateY(-1px);
        }

        #appleSignInBtnLogin:active {
            transform: translateY(0);
        }

        body.dark-theme #appleSignInBtnLogin {
            background: #fff;
            color: #000;
        }

        body.dark-theme #appleSignInBtnLogin:hover {
            background: #e0e0e0 !important;
        }

        body.dark-theme #appleLoginStatus {
            color: #adb5bd !important;
        }

        body.dark-theme #userInfo {
            color: #e9ecef !important;
        }

        body.dark-theme .login-box {
            background: #2c3e50;
        }

        body.dark-theme .login-box h2 {
            color: #fff;
        }
        
        body.dark-theme .login-box .app-badge {
            color: #0b5ed7;
            background: #e7f1ff;
            border-color: #b6d4fe;
        }

        body.dark-theme .login-form-group label {
            color: #e1e8ed;
        }

        body.dark-theme .login-form-group input {
            background: #34495e;
            border-color: #495057;
            color: #fff;
        }

        body.dark-theme .login-form-group input:focus {
            border-color: #3498db;
        }

        body.dark-theme .login-form-group input::placeholder {
            color: #95a5a6;
        }

        /* éšè—ä¸»è¦å†…å®¹ï¼ˆæœªç™»å½•æ—¶ï¼‰ */
        .main-content {
            display: none;
        }

        .main-content.logged-in {
            display: block;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2>PROINVENTORY <span class="app-badge">WEB</span></h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="login-form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required autofocus>
                </div>
                <div class="login-form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="login-btn">ç™»å½•</button>
                <div id="loginError" class="login-error"></div>
            </form>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e1e8ed;">
                <p style="text-align: center; color: #6c757d; font-size: 0.9em; margin-bottom: 15px;">æˆ–ä½¿ç”¨ Apple ID ç™»å½•ï¼ˆç”¨äºæ•°æ®å†™å…¥æ“ä½œï¼‰</p>
                <button type="button" id="appleSignInBtnLogin" onclick="handleAppleSignInFromLogin()" style="width: 100%; padding: 12px; background: #000; color: #fff; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: background 0.3s;">
                    <span style="margin-right: 8px;">ğŸ</span>ä½¿ç”¨ Apple ID ç™»å½•
                </button>
                <div id="appleLoginStatus" style="margin-top: 10px; text-align: center; font-size: 0.85em; color: #6c757d; min-height: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
    <div id="mainContent" class="main-content">
    <div class="container">
        <div class="header">
            <h1>PROINVENTORY <span class="app-badge">WEB</span></h1>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label class="theme-toggle" title="åˆ‡æ¢æ·±æµ…è‰²">
                    <span id="themeLabel">äº®è‰²</span>
                    <input id="themeCheckbox" type="checkbox" />
                    <span class="knob"></span>
                </label>
                <button class="logout-btn" onclick="handleLogout()" title="ç™»å‡º">ç™»å‡º</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span id="connectionStatus">æ­£åœ¨è¿æ¥ CloudKit...</span>
            </div>
            <div class="status-item" style="display: flex; align-items: center; gap: 10px;">
                <span>æœ€åæ›´æ–°: <span id="lastUpdate">--</span></span>
                <span id="userInfo" style="display: none; font-size: 0.85em; color: #6c757d;"></span>
            </div>
        </div>

        <!-- å…¬å‘Šæ ï¼ˆæ¥è‡ª iOS é€šçŸ¥æ¨¡å—ï¼‰ -->
        <div id="noticeBar" class="notice-bar" style="display:none;">
            <div class="notice-list" id="noticeList"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('inventory')">åº“å­˜æ•°æ®</button>
            <button class="tab" onclick="switchTab('stockRecords')">å‡ºå…¥åº“è®°å½•</button>
            <button class="tab" onclick="switchTab('preOutbound')">é¢„å‡ºåº“æ–¹æ¡ˆ</button>
            <button class="tab" onclick="switchTab('traceability')">ç‰©å“è¿½æº¯</button>
        </div>

        <!-- åº“å­˜æ•°æ®æ ‡ç­¾é¡µ -->
        <div id="inventory" class="tab-content active">
            <div class="controls">
                <input type="text" class="search-box" id="inventorySearch" placeholder="æœç´¢ç‰©å“åç§°ã€æ¡ç ã€å“ç‰Œã€å‹å·..." onkeyup="filterInventory()">
                <button class="filter-btn" onclick="showInventoryFilters()">ç­›é€‰</button>
                <button class="refresh-btn" onclick="loadInventory()">åˆ·æ–°</button>
            </div>

            <div class="stats" id="inventoryStats">
                <div class="stat-card clickable" onclick="filterInventoryByStatus('all')" id="statCardAll">
                    <h3 id="totalInventory">0</h3>
                    <p>æ€»ç‰©å“æ•°</p>
                </div>
                <div class="stat-card clickable" onclick="filterInventoryByStatus('åœ¨åº“')" id="statCardInStock">
                    <h3 id="inStockCount">0</h3>
                    <p>åœ¨åº“</p>
                </div>
                <div class="stat-card clickable" onclick="filterInventoryByStatus('å‡ºåº“')" id="statCardOutStock">
                    <h3 id="outStockCount">0</h3>
                    <p>å‡ºåº“</p>
                </div>
                <div class="stat-card clickable" onclick="filterInventoryByStatus('æŸå')" id="statCardDamaged">
                    <h3 id="damagedCount">0</h3>
                    <p>æŸå</p>
                </div>
            </div>

            <div id="inventoryContent">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-bar-text">æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‡ºå…¥åº“è®°å½•æ ‡ç­¾é¡µ -->
        <div id="stockRecords" class="tab-content">
            <div class="controls">
                <input type="text" class="search-box" id="stockSearch" placeholder="æœç´¢è®°å½•ç¼–å·ã€æ“ä½œå‘˜..." onkeyup="filterStockRecords()">
                <button class="filter-btn" onclick="showStockFilters()">ç­›é€‰</button>
                <button class="refresh-btn" onclick="loadStockRecords()">åˆ·æ–°</button>
            </div>

            <div id="stockStatsToggle" class="stats-toggle" onclick="toggleStats('stock')">
                <span class="stats-toggle-label">å‡ºå…¥åº“ç»Ÿè®¡</span>
                <span class="stats-toggle-arrow">â–¼</span>
            </div>
            <div class="stats collapsible" id="stockStats">
                <div class="stat-card">
                    <h3 id="totalStockRecords">0</h3>
                    <p>æ€»è®°å½•æ•°</p>
                </div>
                <div class="stat-card">
                    <h3 id="stockInCount">0</h3>
                    <p>å…¥åº“è®°å½•</p>
                </div>
                <div class="stat-card">
                    <h3 id="stockOutCount">0</h3>
                    <p>å‡ºåº“è®°å½•</p>
                </div>
            </div>

            <div id="stockRecordsContent">
                <div class="loading">æ­£åœ¨åŠ è½½å‡ºå…¥åº“è®°å½•</div>
            </div>
        </div>

        <!-- é¢„å‡ºåº“æ–¹æ¡ˆæ ‡ç­¾é¡µ -->
        <div id="preOutbound" class="tab-content">
            <div class="controls">
                <input type="text" class="search-box" id="preOutboundSearch" placeholder="æœç´¢æ–¹æ¡ˆåç§°ã€åˆ›å»ºè€…ã€æ¡ç ..." onkeyup="filterPreOutbound()">
                <button class="refresh-btn" onclick="loadPreOutboundDesigns()">åˆ·æ–°</button>
                <button class="filter-btn" onclick="openCreatePreOutboundModal()" style="background: #28a745; color: white;">åˆ›å»ºæ–¹æ¡ˆ</button>
            </div>

            <div id="preOutboundStatsToggle" class="stats-toggle" onclick="toggleStats('preOutbound')">
                <span class="stats-toggle-label">é¢„å‡ºåº“æ–¹æ¡ˆç»Ÿè®¡</span>
                <span class="stats-toggle-arrow">â–¼</span>
            </div>
            <div class="stats collapsible" id="preOutboundStats">
                <div class="stat-card">
                    <h3 id="totalPreOutbound">0</h3>
                    <p>æ€»æ–¹æ¡ˆæ•°</p>
                </div>
            </div>

            <div id="preOutboundContent">
                <div class="loading">æ­£åœ¨åŠ è½½é¢„å‡ºåº“æ–¹æ¡ˆ</div>
            </div>
        </div>

        <!-- ç‰©å“è¿½æº¯æ ‡ç­¾é¡µ -->
        <div id="traceability" class="tab-content">
            <div class="controls">
                <input type="text" class="search-box" id="traceBarcodeInput" placeholder="è¾“å…¥ç‰©å“æ¡ç ï¼Œä¾‹å¦‚ 6901234567890">
                <button class="refresh-btn" onclick="handleTraceSearch()">æŸ¥è¯¢è½¨è¿¹</button>
            </div>
            <div class="stats" id="traceStats" style="display:none;">
                <div class="stat-card">
                    <h3 id="traceRecordCount">0</h3>
                    <p>ç›¸å…³è®°å½•</p>
                </div>
            </div>
            <div id="traceContent">
                <div class="empty-state"><p>è¯·è¾“å…¥æ¡ç åæŸ¥è¯¢ç‰©å“è¿½æº¯</p></div>
            </div>
        </div>
    </div>
    </div> <!-- ç»“æŸ main-content -->

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">è¯¦æƒ…</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºé¢„å‡ºåº“æ–¹æ¡ˆæ¨¡æ€æ¡† -->
    <div id="createPreOutboundModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>åˆ›å»ºé¢„å‡ºåº“æ–¹æ¡ˆ</h2>
                <span class="close" onclick="closeCreatePreOutboundModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createPreOutboundForm" onsubmit="savePreOutboundDesign(event)">
                    <div class="detail-section">
                        <h3>åŸºæœ¬ä¿¡æ¯</h3>
                        <div class="detail-grid">
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <span class="detail-label">æ–¹æ¡ˆåç§° <span style="color: #dc3545;">*</span></span>
                                <input type="text" id="designName" required style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1em;" placeholder="è¯·è¾“å…¥æ–¹æ¡ˆåç§°">
                            </div>
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <span class="detail-label">æ¼”å‡ºä¿¡æ¯</span>
                                <input type="text" id="designEventInfo" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1em;" placeholder="è¯·è¾“å…¥æ¼”å‡ºä¿¡æ¯">
                            </div>
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <span class="detail-label">æ¼”å‡ºåœ°ç‚¹</span>
                                <input type="text" id="designEventLocation" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1em;" placeholder="è¯·è¾“å…¥æ¼”å‡ºåœ°ç‚¹">
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">æ¼”å‡ºå¼€å§‹æ—¥æœŸ</span>
                                <input type="date" id="designEventStartDate" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1em;">
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">æ¼”å‡ºç»“æŸæ—¥æœŸ</span>
                                <input type="date" id="designEventEndDate" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1em;">
                            </div>
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <span class="detail-label">åˆ›å»ºè€…</span>
                                <input type="text" id="designCreator" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1em;" placeholder="è¯·è¾“å…¥åˆ›å»ºè€…åç§°" value="admin">
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>é€‰æ‹©ç‰©å“ <span style="font-size: 0.8em; font-weight: normal; color: #6c757d;">(å·²é€‰æ‹© <span id="selectedItemsCount">0</span> ä¸ªç‰©å“)</span></h3>
                        <div style="margin-bottom: 15px;">
                            <input type="text" id="itemSearchInput" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 1em; margin-bottom: 10px;" placeholder="æœç´¢ç‰©å“ï¼ˆæ¡ç ã€åç§°ã€å“ç‰Œã€å‹å·ï¼‰" onkeyup="filterItemsForSelection()">
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 6px; padding: 10px;">
                                <div id="itemSelectionList">
                                    <div style="text-align: center; color: #6c757d; padding: 20px;">æ­£åœ¨åŠ è½½ç‰©å“åˆ—è¡¨...</div>
                                </div>
                            </div>
                        </div>
                        <div id="selectedItemsList" style="margin-top: 15px;">
                            <h4 style="margin-bottom: 10px; font-size: 1em;">å·²é€‰ç‰©å“ï¼š</h4>
                            <div id="selectedItemsDisplay" style="min-height: 50px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                <div style="text-align: center; color: #6c757d;">æš‚æ— é€‰æ‹©çš„ç‰©å“</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="filter-btn" onclick="closeCreatePreOutboundModal()" style="background: #6c757d;">å–æ¶ˆ</button>
                        <button type="submit" class="filter-btn" style="background: #28a745; color: white;">ä¿å­˜æ–¹æ¡ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ==================== ç™»å½•æ¨¡å— ====================
        const LOGIN_USERNAME = 'admin';
        const LOGIN_PASSWORD = 'zggjwjy';
        const LOGIN_STORAGE_KEY = 'proinventory_logged_in';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem(LOGIN_STORAGE_KEY) === 'true';
            if (isLoggedIn) {
                showMainContent();
            } else {
                showLoginForm();
            }
        }

        // æ˜¾ç¤ºç™»å½•ç•Œé¢
        function showLoginForm() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('logged-in');
            document.body.classList.remove('logged-in');
            // å¦‚æœ CloudKit å·²åˆå§‹åŒ–ï¼Œæ£€æŸ¥ Apple ID ç™»å½•çŠ¶æ€
            if (cloudKit) {
                checkAppleLoginStatus();
            }
        }

        // æ£€æŸ¥ Apple ID ç™»å½•çŠ¶æ€ï¼ˆåœ¨ç™»å½•é¡µé¢æ˜¾ç¤ºï¼‰
        async function checkAppleLoginStatus() {
            if (!cloudKit) return;
            
            try {
                const userIdentity = cloudKit.currentUserIdentity;
                const statusDiv = document.getElementById('appleLoginStatus');
                const loginBtn = document.getElementById('appleSignInBtnLogin');
                
                if (userIdentity) {
                    if (statusDiv) {
                        statusDiv.innerHTML = '<span style="color: #28a745;">âœ“ Apple ID å·²ç™»å½•</span>';
                    }
                    if (loginBtn) {
                        loginBtn.textContent = 'âœ“ Apple ID å·²ç™»å½•';
                        loginBtn.style.background = '#28a745';
                        loginBtn.disabled = true;
                    }
                } else {
                    if (statusDiv) {
                        statusDiv.innerHTML = '';
                    }
                    if (loginBtn) {
                        loginBtn.textContent = 'ğŸ ä½¿ç”¨ Apple ID ç™»å½•';
                        loginBtn.style.background = '#000';
                        loginBtn.disabled = false;
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥ Apple ID ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºä¸»è¦å†…å®¹
        function showMainContent() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContent').classList.add('logged-in');
            document.body.classList.add('logged-in');
        }

        // å¤„ç†ç™»å½•
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            errorDiv.textContent = '';

            if (username === LOGIN_USERNAME && password === LOGIN_PASSWORD) {
                // ç™»å½•æˆåŠŸ
                localStorage.setItem(LOGIN_STORAGE_KEY, 'true');
                showMainContent();
                // ç™»å½•æˆåŠŸååˆå§‹åŒ– CloudKit
                initCloudKit();
            } else {
                // ç™»å½•å¤±è´¥
                errorDiv.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
        }

        // å¤„ç†ç™»å‡º
        function handleLogout() {
            if (confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                localStorage.removeItem(LOGIN_STORAGE_KEY);
                showLoginForm();
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('loginError').textContent = '';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            // å³ä½¿æœªç™»å½•ï¼Œä¹Ÿåˆå§‹åŒ– CloudKitï¼ˆç”¨äº Apple ID ç™»å½•ï¼‰
            // ä½†åªåˆå§‹åŒ–ï¼Œä¸åŠ è½½æ•°æ®
            if (!cloudKit) {
                initCloudKitForAuthOnly();
            }
        });

        // ä»…åˆå§‹åŒ– CloudKit ç”¨äºè®¤è¯ï¼ˆä¸åŠ è½½æ•°æ®ï¼‰
        async function initCloudKitForAuthOnly() {
            try {
                // é…ç½® CloudKit
                CloudKit.configure({
                    containers: [{
                        containerIdentifier: CloudKitConfig.containerIdentifier,
                        apiToken: CloudKitConfig.apiToken,
                        environment: CloudKitConfig.environment,
                        apiTokenAuth: {
                            apiToken: CloudKitConfig.apiToken,
                            persist: false,
                            signInButton: null,
                            signOutButton: null
                        },
                        services: {
                            fetch: window.fetch.bind(window)
                        }
                    }]
                });

                cloudKit = CloudKit.getDefaultContainer();
                
                // åˆå§‹åŒ–è®¤è¯
                try {
                    await cloudKit.setUpAuth();
                    // æ£€æŸ¥ Apple ID ç™»å½•çŠ¶æ€
                    checkAppleLoginStatus();
                } catch (authError) {
                    console.warn('è®¤è¯åˆå§‹åŒ–å¤±è´¥ï¼ˆç™»å½•é¡µé¢ï¼‰:', authError);
                }
            } catch (error) {
                console.warn('CloudKit åˆå§‹åŒ–å¤±è´¥ï¼ˆç™»å½•é¡µé¢ï¼‰:', error);
            }
        }

        // ==================== CloudKit é…ç½® ====================
        // å¦‚æœå­˜åœ¨ config.js æ–‡ä»¶ï¼Œå…¶ä¸­çš„é…ç½®ä¼šè¦†ç›–è¿™é‡Œçš„é»˜è®¤é…ç½®
        // å»ºè®®åˆ›å»º config.js æ–‡ä»¶ï¼ˆåŸºäº config.example.jsï¼‰æ¥é…ç½® API Token
        let CloudKitConfig = window.CloudKitConfig || {
            containerIdentifier: 'iCloud.Richard.Proinventory',
            apiToken: 'fede1906ce6c295de1c2dc43b1d2b838c278c5439c272b7aec59ec67e9e5c2e3', // API Token
            environment: 'development' // æˆ– 'production'
        };

        let cloudKit;
        let inventoryData = [];
        let filteredInventoryData = null; // å½“å‰ç­›é€‰åçš„åº“å­˜æ•°æ®
        let currentStatusFilter = 'all'; // å½“å‰çŠ¶æ€ç­›é€‰ï¼š'all', 'åœ¨åº“', 'å‡ºåº“', 'æŸå'
        let stockRecordsData = [];
        let preOutboundData = [];
        let traceRecordsCache = null; // å¦‚éœ€å›é€€åˆ°å…¨é‡è¿‡æ»¤å¯ç”¨
        let announcementsData = [];
        let noticesData = [];

        // åˆå§‹åŒ– CloudKit
        async function initCloudKit() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const isLoggedIn = localStorage.getItem(LOGIN_STORAGE_KEY) === 'true';
            if (!isLoggedIn) {
                console.log('æœªç™»å½•ï¼Œè·³è¿‡ CloudKit åˆå§‹åŒ–');
                return;
            }

            // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œåªé‡æ–°æ£€æŸ¥è®¤è¯çŠ¶æ€
            if (cloudKit) {
                try {
                    await cloudKit.setUpAuth();
                    const userIdentity = cloudKit.currentUserIdentity;
                    updateUserAuthUI(userIdentity);
                    return;
                } catch (e) {
                    console.warn('é‡æ–°åˆå§‹åŒ–è®¤è¯å¤±è´¥:', e);
                }
            }

            try {
                // é…ç½® CloudKit
                CloudKit.configure({
                    containers: [{
                        containerIdentifier: CloudKitConfig.containerIdentifier,
                        apiToken: CloudKitConfig.apiToken,
                        environment: CloudKitConfig.environment,
                        // é…ç½® API Token è®¤è¯ï¼ˆç”¨äºè¯»å–ï¼‰
                        apiTokenAuth: {
                            apiToken: CloudKitConfig.apiToken,
                            persist: false,
                            signInButton: null,
                            signOutButton: null
                        },
                        // é…ç½®ç”¨æˆ·èº«ä»½è®¤è¯ï¼ˆç”¨äºå†™å…¥ï¼‰
                        services: {
                            fetch: window.fetch.bind(window)
                        }
                    }]
                });

                cloudKit = CloudKit.getDefaultContainer();
                
                // è®¾ç½®è®¤è¯çŠ¶æ€ - å¯¹äºå…¬å…±æ•°æ®åº“ï¼Œå…è®¸åŒ¿åè®¿é—®
                document.getElementById('connectionStatus').textContent = 'âœ“ æ­£åœ¨åˆå§‹åŒ– CloudKit...';
                document.getElementById('connectionStatus').style.color = '#ffc107';
                
                try {
                    // è°ƒç”¨ setUpAuth() æ¥åˆå§‹åŒ–è®¤è¯çŠ¶æ€
                    const authResult = await cloudKit.setUpAuth();
                    console.log('è®¤è¯çŠ¶æ€:', authResult);
                    
                    // æ£€æŸ¥ç”¨æˆ·èº«ä»½
                    const userIdentity = cloudKit.currentUserIdentity;
                    console.log('å½“å‰ç”¨æˆ·èº«ä»½:', userIdentity);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ä»Appleç™»å½•é¡µé¢è¿”å›
                    const returnUrl = sessionStorage.getItem('returnUrl');
                    const appleLoginInProgress = sessionStorage.getItem('appleLoginInProgress');
                    if (returnUrl || appleLoginInProgress) {
                        sessionStorage.removeItem('returnUrl');
                        sessionStorage.removeItem('appleLoginInProgress');
                        // é‡æ–°åˆå§‹åŒ–è®¤è¯ä»¥è·å–æœ€æ–°çŠ¶æ€
                        try {
                            await cloudKit.setUpAuth();
                        } catch (e) {
                            console.warn('é‡æ–°åˆå§‹åŒ–è®¤è¯å¤±è´¥:', e);
                        }
                        // é‡æ–°æ£€æŸ¥ç”¨æˆ·èº«ä»½ï¼ˆç™»å½•åï¼‰
                        const refreshedIdentity = cloudKit.currentUserIdentity;
                        if (refreshedIdentity) {
                            console.log('æ£€æµ‹åˆ°ä»Appleç™»å½•é¡µé¢è¿”å›ï¼Œç”¨æˆ·å·²ç™»å½•:', refreshedIdentity);
                        }
                    }
                    
                    // æ›´æ–°ç™»å½•æŒ‰é’®å’Œç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                    const finalUserIdentity = cloudKit.currentUserIdentity;
                    updateUserAuthUI(finalUserIdentity);
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”¨æˆ·ç™»å½•ï¼ˆå¯¹äºå…¬å…±æ•°æ®åº“é€šå¸¸ä¸éœ€è¦ï¼‰
                    if (authResult === 'development' || authResult === 'production') {
                        if (finalUserIdentity) {
                            document.getElementById('connectionStatus').textContent = `âœ“ å·²è¿æ¥åˆ° CloudKit (ç”¨æˆ·: ${finalUserIdentity.nameComponents?.givenName || 'å·²ç™»å½•'})`;
                        } else {
                            document.getElementById('connectionStatus').textContent = 'âœ“ å·²è¿æ¥åˆ° CloudKitï¼ˆåŒ¿åæ¨¡å¼ï¼Œå†™å…¥æ“ä½œéœ€è¦ç™»å½•ï¼‰';
                        }
                        document.getElementById('connectionStatus').style.color = '#28a745';
                        
                        // åŠ è½½æ•°æ®
                        await Promise.all([
                            loadInventory(),
                            loadStockRecords(),
                            loadPreOutboundDesigns()
                        ]);
                        // åŠ è½½å…¬å‘Šæ 
                        loadNotifications().catch(() => {});
                    } else {
                        // å¦‚æœè¿”å›çš„æ˜¯é‡å®šå‘URLï¼Œè¯´æ˜éœ€è¦ç”¨æˆ·ç™»å½•
                        console.warn('è®¤è¯çŠ¶æ€å¼‚å¸¸ï¼Œä½†å°è¯•ç»§ç»­è®¿é—®å…¬å…±æ•°æ®åº“:', authResult);
                        document.getElementById('connectionStatus').textContent = 'âœ“ å·²è¿æ¥åˆ° CloudKitï¼ˆåŒ¿åæ¨¡å¼ï¼Œå†™å…¥æ“ä½œéœ€è¦ç™»å½•ï¼‰';
                        document.getElementById('connectionStatus').style.color = '#28a745';
                        
                        // ä»ç„¶å°è¯•åŠ è½½æ•°æ®ï¼ˆå…¬å…±æ•°æ®åº“å…è®¸åŒ¿åè®¿é—®ï¼‰
                        await Promise.all([
                            loadInventory(),
                            loadStockRecords(),
                            loadPreOutboundDesigns()
                        ]);
                        // åŠ è½½å…¬å‘Šæ 
                        loadNotifications().catch(() => {});
                    }
                } catch (authError) {
                    // è®¤è¯å¤±è´¥ï¼Œä½†å¯¹äºå…¬å…±æ•°æ®åº“ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥å°è¯•è®¿é—®
                    console.warn('è®¤è¯åˆå§‹åŒ–å¤±è´¥ï¼Œä½†å°è¯•ç»§ç»­è®¿é—®å…¬å…±æ•°æ®åº“:', authError);
                    document.getElementById('connectionStatus').textContent = 'âœ“ å·²è¿æ¥åˆ° CloudKitï¼ˆåŒ¿åæ¨¡å¼ï¼‰';
                    document.getElementById('connectionStatus').style.color = '#ffc107';
                    
                    // å°è¯•ç›´æ¥è®¿é—®å…¬å…±æ•°æ®åº“
                    try {
                        const testQuery = {
                            recordType: 'Inventory',
                            filterBy: [],
                            sortBy: [{ fieldName: 'name', ascending: true }],
                            resultsLimit: 1
                        };
                        
                        await cloudKit.publicCloudDatabase.performQuery(testQuery);
                        
                        document.getElementById('connectionStatus').textContent = 'âœ“ å·²è¿æ¥åˆ° CloudKit';
                        document.getElementById('connectionStatus').style.color = '#28a745';
                        
                        // åŠ è½½æ•°æ®
                        await Promise.all([
                            loadInventory(),
                            loadStockRecords(),
                            loadPreOutboundDesigns()
                        ]);
                        // åŠ è½½å…¬å‘Šæ 
                        loadNotifications().catch(() => {});
                    } catch (queryError) {
                        // æŸ¥è¯¢ä¹Ÿå¤±è´¥äº†
                        throw new Error('æ— æ³•è®¿é—® CloudKit æ•°æ®åº“: ' + (queryError.message || queryError));
                    }
                }
            } catch (error) {
                console.error('CloudKit åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('connectionStatus').textContent = 'âœ— CloudKit è¿æ¥å¤±è´¥';
                document.getElementById('connectionStatus').style.color = '#dc3545';
                
                let errorMessage = 'æ— æ³•è¿æ¥åˆ° CloudKitã€‚';
                if (error.message) {
                    errorMessage += ' é”™è¯¯: ' + error.message;
                }
                if (error.ckErrorCode) {
                    errorMessage += ' (é”™è¯¯ä»£ç : ' + error.ckErrorCode + ')';
                }
                errorMessage += '<br><br>è¯·æ£€æŸ¥ï¼š<br>';
                errorMessage += '1. API Token æ˜¯å¦æ­£ç¡®ä¸”æœ‰æ•ˆ<br>';
                errorMessage += '2. å®¹å™¨æ ‡è¯†ç¬¦æ˜¯å¦æ­£ç¡®<br>';
                errorMessage += '3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>';
                errorMessage += '4. CloudKit ç¯å¢ƒè®¾ç½®æ˜¯å¦æ­£ç¡®ï¼ˆdevelopment/productionï¼‰<br>';
                errorMessage += '5. åœ¨ CloudKit Dashboard ä¸­ç¡®è®¤å…¬å…±æ•°æ®åº“æƒé™å·²æ­£ç¡®é…ç½®';
                
                showError('inventoryContent', errorMessage);
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // æ‰‹æœºç«¯ç»Ÿè®¡ä¿¡æ¯æŠ˜å /å±•å¼€
        function toggleStats(type) {
            const statsId = type === 'stock' ? 'stockStats' : 'preOutboundStats';
            const toggleId = type === 'stock' ? 'stockStatsToggle' : 'preOutboundStatsToggle';
            const statsEl = document.getElementById(statsId);
            const toggleEl = document.getElementById(toggleId);
            if (!statsEl || !toggleEl) return;
            const arrow = toggleEl.querySelector('.stats-toggle-arrow');
            const expanded = statsEl.classList.toggle('expanded');
            if (arrow) {
                arrow.textContent = expanded ? 'â–²' : 'â–¼';
            }
        }

        // å…¬å‘Šæ ï¼šåŠ è½½ä¸æ¸²æŸ“
        async function loadNotifications() {
            try {
                // åŠ è½½é€šçŸ¥ï¼ˆAnnouncementï¼‰
                const annQuery = {
                    recordType: 'Announcement',
                    filterBy: [],
                    sortBy: [{ fieldName: 'date', ascending: false }],
                    resultsLimit: 50
                };
                const annResp = await cloudKit.publicCloudDatabase.performQuery(annQuery);
                if (!(annResp.hasErrors && annResp.errors?.length)) {
                    announcementsData = (annResp.records || []).map(r => mapNotificationRecord(r, 'é€šçŸ¥'));
                }

                // iOS å¯¹åº”ä»…ä½¿ç”¨ Announcementï¼Œå› æ­¤ Notice ç•™ç©º
                noticesData = [];

                renderNotificationBar();
            } catch (e) {
                console.warn('åŠ è½½å…¬å‘Šæ å¤±è´¥:', e);
            }
        }

        // ç”Ÿæˆè¿›åº¦æ¡HTML
        function createProgressBar(text) {
            return `<div class="progress-bar-container">
                <div class="progress-bar">
                    <div class="progress-bar-text">${escapeHtml(text)}</div>
                </div>
            </div>`;
        }

        // é€šç”¨ï¼šåˆ†é¡µåŠ è½½æ‰€æœ‰è®°å½•ï¼ˆå…¼å®¹ cursor ä¸ continuationMarkerï¼‰
        async function fetchAllRecordsPaged({ recordType, filterBy = [], sortBy = [], resultsLimit = 400, maxPages = 1000 }) {
            const query = { recordType, filterBy, sortBy };
            let all = [];
            // é¦–æ¬¡è¯·æ±‚
            let resp = await cloudKit.publicCloudDatabase.performQuery(query, { resultsLimit });
            if (resp.hasErrors && resp.errors.length > 0) {
                throw new Error(resp.errors[0].message || 'æŸ¥è¯¢å¤±è´¥');
            }
            all.push(...(resp.records || []));
            let cursor = resp.cursor || null;
            let marker = resp.continuationMarker || null;
            let page = 0;
            while ((cursor || marker) && page < maxPages) {
                page++;
                if (cursor) {
                    resp = await cloudKit.publicCloudDatabase.performQuery(query, { cursor, resultsLimit });
                } else {
                    resp = await cloudKit.publicCloudDatabase.performQuery(query, { continuationMarker: marker, resultsLimit });
                }
                if (resp.hasErrors && resp.errors.length > 0) {
                    console.warn('åˆ†é¡µæŸ¥è¯¢å‡ºé”™:', resp.errors[0].message);
                    break;
                }
                all.push(...(resp.records || []));
                cursor = resp.cursor || null;
                marker = resp.continuationMarker || null;
            }
            return all;
        }

        function mapNotificationRecord(record, kind) {
            const f = record.fields || {};
            return {
                id: record.recordName || record.recordID?.recordName || '',
                kind,
                title: f.title?.value || (kind + 'æ— æ ‡é¢˜'),
                content: f.content?.value || '',
                date: f.date?.value ? new Date(f.date.value) : null
            };
        }

        function renderNotificationBar() {
            const listEl = document.getElementById('noticeList');
            const barEl = document.getElementById('noticeBar');
            const items = [...announcementsData, ...noticesData]
                .filter(x => !!x)
                .sort((a, b) => (b.date?.getTime() || 0) - (a.date?.getTime() || 0))
                .slice(0, 4);
            let html = '';
            if (items.length === 0) {
                html += '<div class="notice-item">';
                html += '<span class="notice-badge">å…¬å‘Š</span>';
                html += '<div class="notice-title">æš‚æ— å…¬å‘Šæˆ–é€šçŸ¥</div>';
                html += '</div>';
                listEl.innerHTML = html;
                barEl.style.display = 'block';
                return;
            }
            items.forEach(it => {
                const timeText = it.date ? it.date.toLocaleDateString('zh-CN') : '';
                html += '<div class=\"notice-item\">';
                html += `<span class=\"notice-badge\">${it.kind}</span>`;
                html += `<div class=\"notice-title\" title=\"${escapeHtml(it.title)}\">${escapeHtml(it.title)}</div>`;
                html += `<div class=\"notice-time\">${timeText}</div>`;
                html += '</div>';
            });
            listEl.innerHTML = html;
            barEl.style.display = 'block';
        }
        // é¢„å‡ºåº“æ–¹æ¡ˆï¼šè·å–å±•ç¤ºç”¨æ¡ç ï¼ˆæ— æ¡ç åˆ™æŒ‰åˆ›å»ºæ—¥æœŸç”Ÿæˆ yyyyMMddHHmmssï¼‰
        function getDesignBarcode(design) {
            const raw = (design && design.barcode) ? String(design.barcode).trim() : '';
            if (raw) return raw;
            const date = design && design.designDate ? new Date(design.designDate) : new Date();
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            const ss = String(date.getSeconds()).padStart(2, '0');
            return `P${y}${m}${d}${hh}${mm}${ss}`;
        }

        // ç‰©å“æµè½¬è¿½æº¯ - å¤„ç†æŸ¥è¯¢
        async function handleTraceSearch() {
            const barcode = (document.getElementById('traceBarcodeInput').value || '').trim();
            const contentDiv = document.getElementById('traceContent');
            if (!barcode) {
                contentDiv.innerHTML = '<div class="empty-state"><p>è¯·è¾“å…¥æ¡ç </p></div>';
                document.getElementById('traceStats').style.display = 'none';
                return;
            }
            contentDiv.innerHTML = '<div class="loading">æ­£åœ¨æŸ¥è¯¢è½¨è¿¹</div>';
            try {
                const records = await loadTraceRecordsByBarcode(barcode);
                displayTraceResults(records, barcode);
            } catch (e) {
                console.error('æŸ¥è¯¢è½¨è¿¹å¤±è´¥:', e);
                showError('traceContent', 'æŸ¥è¯¢è½¨è¿¹å¤±è´¥ï¼š' + (e.message || e));
            }
        }

        // ç‰©å“æµè½¬è¿½æº¯ - æŸ¥è¯¢ï¼šä¼˜å…ˆä½¿ç”¨ CloudKit åˆ—è¡¨åŒ…å«æŸ¥è¯¢ï¼›å¤±è´¥åˆ™å›é€€åˆ°å…¨é‡æ‹‰å–åæœ¬åœ°è¿‡æ»¤
        async function loadTraceRecordsByBarcode(barcode) {
            // ä¼˜å…ˆå°è¯•æœåŠ¡ç«¯è¿‡æ»¤ï¼ˆåˆ—è¡¨åŒ…å«ï¼‰
            try {
                const query = {
                    recordType: 'StockRecord',
                    filterBy: [{
                        fieldName: 'itemIDs',
                        comparator: 'CONTAINS_ANY',
                        fieldValue: { value: [barcode] }
                    }],
                    sortBy: [{ fieldName: 'date', ascending: true }],
                    resultsLimit: 400
                };
                let all = [];
                let resp = await cloudKit.publicCloudDatabase.performQuery(query);
                if (resp.hasErrors && resp.errors.length > 0) {
                    throw new Error(resp.errors[0].message || 'æŸ¥è¯¢å¤±è´¥');
                }
                all.push(...(resp.records || []));
                let next = resp.cursor || resp.continuationMarker || null;
                let pages = 0;
                while (next && pages < 50) {
                    pages++;
                    const nextQuery = { recordType: 'StockRecord', cursor: next, resultsLimit: 400 };
                    resp = await cloudKit.publicCloudDatabase.performQuery(nextQuery);
                    if (resp.hasErrors && resp.errors.length > 0) break;
                    all.push(...(resp.records || []));
                    next = resp.cursor || resp.continuationMarker || null;
                }
                return all.map(r => mapStockRecordBasic(r)).filter(r => r != null);
            } catch (err) {
                console.warn('æœåŠ¡ç«¯åŒ…å«æŸ¥è¯¢ä¸å¯ç”¨ï¼Œå›é€€åˆ°å…¨é‡è¿‡æ»¤:', err);
                // å›é€€ï¼šå…¨é‡åˆ†é¡µè·å–ååœ¨æœ¬åœ°è¿‡æ»¤
                const all = await loadAllStockRecordsPaged();
                return all.filter(r => (r.itemIDs || []).includes(barcode))
                          .sort((a, b) => new Date(a.date) - new Date(b.date));
            }
        }

        // åˆ†é¡µæ‹‰å–æ‰€æœ‰å‡ºå…¥åº“è®°å½•ï¼ˆåŸºç¡€å­—æ®µï¼‰
        async function loadAllStockRecordsPaged() {
            if (traceRecordsCache) return traceRecordsCache;
            const baseQuery = {
                recordType: 'StockRecord',
                filterBy: [],
                sortBy: [{ fieldName: 'date', ascending: false }],
                resultsLimit: 400
            };
            let all = [];
            let resp = await cloudKit.publicCloudDatabase.performQuery(baseQuery);
            if (!(resp.hasErrors && resp.errors?.length)) {
                all.push(...(resp.records || []));
            }
            let next = resp.cursor || resp.continuationMarker || null;
            let pages = 0;
            while (next && pages < 50) {
                pages++;
                const nextQuery = { recordType: 'StockRecord', cursor: next, resultsLimit: 400 };
                resp = await cloudKit.publicCloudDatabase.performQuery(nextQuery);
                if (resp.hasErrors && resp.errors.length > 0) break;
                all.push(...(resp.records || []));
                next = resp.cursor || resp.continuationMarker || null;
            }
            traceRecordsCache = all.map(r => mapStockRecordBasic(r)).filter(r => r != null);
            return traceRecordsCache;
        }

        // å°† CKRecord æ˜ å°„ä¸ºåŸºç¡€ StockRecord ç»“æ„ï¼ˆä»…æ¸²æŸ“æ‰€éœ€å­—æ®µï¼‰
        function mapStockRecordBasic(record) {
            const f = record.fields || {};
            const date = f.date?.value ? new Date(f.date.value) : null;
            if (!f.recordNumber?.value || !f.type?.value || !date) return null;
            return {
                id: record.recordName || record.recordID?.recordName || '',
                recordNumber: f.recordNumber.value,
                type: f.type.value, // 'stockIn' | 'stockOut'
                itemIDs: f.itemIDs?.value || [],
                date: date,
                eventInfo: f.eventInfo?.value || '',
                eventLocation: f.eventLocation?.value || '',
                boxCount: f.boxCount?.value || 0,
                operatorUsername: f.operatorUsername?.value || 'æœªçŸ¥ç”¨æˆ·'
            };
        }

        // æ¸²æŸ“è½¨è¿¹ç»“æœ
        function displayTraceResults(records, barcode) {
            const contentDiv = document.getElementById('traceContent');
            const stats = document.getElementById('traceStats');
            const countEl = document.getElementById('traceRecordCount');
            records = (records || []).sort((a, b) => a.date - b.date);
            countEl.textContent = records.length;
            stats.style.display = 'block';
            if (records.length === 0) {
                contentDiv.innerHTML = `<div class=\"empty-state\"><p>æ¡ç  ${escapeHtml(barcode)} æš‚æ— æµè½¬è®°å½•</p></div>`;
                return;
            }
            let html = '<div class=\"item-list\">';
            const ts = Date.now();
            records.forEach((rec, idx) => {
                const typeClass = rec.type === 'stockIn' ? 'type-stockIn' : 'type-stockOut';
                const typeText = rec.type === 'stockIn' ? 'å…¥åº“' : 'å‡ºåº“';
                const dateText = new Date(rec.date).toLocaleString('zh-CN');
                const barcodeId = `tracebarcode-${idx}-${ts}`;
                html += '<div class=\"item-card\">';
                html += '<div class=\"item-header\">';
                // å·¦ï¼šçŠ¶æ€æ ‡è¯†
                html += `<div style=\"display:flex; align-items:center; gap:10px;\"><span class=\"type-badge ${typeClass}\">${typeText}</span></div>`;
                // å³ï¼šè®°å½•ç¼–å·æ¡ç 
                html += `<div class=\"barcode-container\" style=\"margin-left:auto;\"><svg id=\"${barcodeId}\" class=\"barcode-image\" style=\"max-width: 120px;\"></svg><span class=\"barcode-text\">${escapeHtml(rec.recordNumber)}</span></div>`;
                html += '</div>';
                html += '<div class=\"item-details\">';
                html += `<div class=\"detail-item\"><span class=\"detail-label\">æ—¥æœŸ</span><span class=\"detail-value\">${dateText}</span></div>`;
                html += `<div class=\"detail-item\"><span class=\"detail-label\">æ“ä½œå‘˜</span><span class=\"detail-value\">${escapeHtml(formatField(rec.operatorUsername))}</span></div>`;
                html += `<div class=\"detail-item\"><span class=\"detail-label\">æ¼”å‡ºä¿¡æ¯</span><span class=\"detail-value\">${escapeHtml(formatField(rec.eventInfo))}</span></div>`;
                html += `<div class=\"detail-item\"><span class=\"detail-label\">æ¼”å‡ºåœ°ç‚¹</span><span class=\"detail-value\">${escapeHtml(formatField(rec.eventLocation))}</span></div>`;
                html += `<div class=\"detail-item\"><span class=\"detail-label\">ç®±æ•°</span><span class=\"detail-value\">${rec.boxCount ? rec.boxCount : 'æ— '}</span></div>`;
                html += '</div>';
                html += '</div>';
            });
            html += '</div>';
            contentDiv.innerHTML = html;
            // æ‰¹é‡æ¸²æŸ“æ¡å½¢ç ï¼ˆæ‰‹æœºç«¯è‡ªé€‚åº”ï¼‰
            setTimeout(() => {
                const isMobile = window.innerWidth <= 576;
                records.forEach((rec, idx) => {
                    const el = document.getElementById(`tracebarcode-${idx}-${ts}`);
                    if (!el) return;
                    try {
                        JsBarcode(el, String(rec.recordNumber), {
                            format: 'CODE128',
                            width: isMobile ? 1.3 : 2,
                            height: isMobile ? 38 : 48,
                            displayValue: false,
                            margin: 3,
                            background: '#ffffff',
                            lineColor: '#000000'
                        });
                        if (isMobile) {
                            el.removeAttribute('width');
                            el.style.maxWidth = '40vw';
                            el.style.width = '100%';
                            el.style.height = 'auto';
                        } else {
                            el.style.maxWidth = '140px';
                        }
                    } catch (e) {
                        console.warn('æ¸²æŸ“è½¨è¿¹æ¡ç å¤±è´¥:', e);
                    }
                });
            }, 50);
        }

        // åŠ è½½åº“å­˜æ•°æ®ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
        async function loadInventory() {
            const contentDiv = document.getElementById('inventoryContent');
            contentDiv.innerHTML = createProgressBar('æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®');

            try {
                let allRecords = [];
                let seenIds = new Set(); // ç”¨äºå»é‡
                let pageCount = 0;
                const maxPages = 1000; // æ”¾å®½é¡µæ•°ä¸Šé™ï¼Œé˜²æ­¢æå‰ç»ˆæ­¢

                // æŒ‰ barcode æ’åºï¼Œä¿è¯è·¨é¡µé¡ºåºä¸€è‡´ï¼›resultsLimit æ”¾åœ¨ options é‡Œ
                const baseQuery = {
                    recordType: 'Inventory',
                    filterBy: [], // ç©ºæ•°ç»„è¡¨ç¤ºè·å–æ‰€æœ‰è®°å½•
                    sortBy: [{ fieldName: 'barcode', ascending: true }]
                };

                // é¦–é¡µæŸ¥è¯¢ï¼ˆä½¿ç”¨ options.resultsLimitï¼‰
                let response = await cloudKit.publicCloudDatabase.performQuery(baseQuery, { resultsLimit: 400 });
                
                if (response.hasErrors && response.errors.length > 0) {
                    throw new Error(response.errors[0].message || 'æŸ¥è¯¢å¤±è´¥');
                }

                // æ£€æŸ¥å“åº”å¯¹è±¡çš„ç»“æ„
                console.log('CloudKit å“åº”ç»“æ„:', response);
                
                // å¤„ç†ç¬¬ä¸€é¡µæ•°æ®
                let records = response.records || [];
                records.forEach(record => {
                    const recordId = record.recordName || record.recordID?.recordName || '';
                    if (recordId && !seenIds.has(recordId)) {
                        seenIds.add(recordId);
                        allRecords.push(record);
                    }
                });
                
                // æ›´æ–°åŠ è½½çŠ¶æ€
                contentDiv.innerHTML = createProgressBar(`æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®... (å·²åŠ è½½ ${allRecords.length} æ¡ï¼Œå»é‡å)`);

                // åŒæ—¶å…¼å®¹ cursor ä¸ continuationMarker
                let nextCursor = response.cursor || null;
                let nextMarker = response.continuationMarker || null;
                
                // å¦‚æœæœ‰åˆ†é¡µæ ‡è®°ï¼Œç»§ç»­æŸ¥è¯¢
                while ((nextCursor || nextMarker) && pageCount < maxPages) {
                    pageCount++;
                    
                    try {
                        // æºå¸¦åŸå§‹æŸ¥è¯¢ï¼ˆå«æ’åºï¼‰ï¼›ä¼˜å…ˆä½¿ç”¨ cursorï¼Œå…¶æ¬¡ continuationMarker
                        if (nextCursor) {
                            response = await cloudKit.publicCloudDatabase.performQuery(
                                baseQuery,
                                { cursor: nextCursor, resultsLimit: 400 }
                            );
                        } else {
                            response = await cloudKit.publicCloudDatabase.performQuery(
                                baseQuery,
                                { continuationMarker: nextMarker, resultsLimit: 400 }
                            );
                        }
                        
                        if (response.hasErrors && response.errors.length > 0) {
                            console.warn('åˆ†é¡µæŸ¥è¯¢å‡ºé”™ï¼Œåœæ­¢ç»§ç»­åŠ è½½:', response.errors[0].message);
                            break;
                        }

                        records = response.records || [];
                        if (records.length === 0) {
                            break; // æ²¡æœ‰æ›´å¤šæ•°æ®
                        }
                        
                        // å»é‡å¤„ç†
                        let newRecordsCount = 0;
                        records.forEach(record => {
                            const recordId = record.recordName || record.recordID?.recordName || '';
                            if (recordId && !seenIds.has(recordId)) {
                                seenIds.add(recordId);
                                allRecords.push(record);
                                newRecordsCount++;
                            }
                        });
                        
                        console.log(`ç¬¬ ${pageCount} é¡µ: è·å– ${records.length} æ¡ï¼Œæ–°å¢ ${newRecordsCount} æ¡ï¼Œæ€»è®¡ ${allRecords.length} æ¡`);
                        
                        // æ›´æ–°åŠ è½½çŠ¶æ€
                        const progressText = contentDiv.querySelector('.progress-bar-text');
                        if (progressText) {
                            progressText.textContent = `æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®... (å·²åŠ è½½ ${allRecords.length} æ¡ï¼Œå»é‡å)`;
                        }
                        
                        // ä¸‹ä¸€é¡µæ ‡è®°ï¼ˆåŒé€šé“å…¼å®¹ï¼‰
                        nextCursor = response.cursor || null;
                        nextMarker = response.continuationMarker || null;
                        
                        // å¦‚æœæ²¡æœ‰æ–°è®°å½•ä¸”æ— åç»­æ ‡è®°ï¼Œé€€å‡ºå¾ªç¯
                        if (newRecordsCount === 0 && !nextCursor && !nextMarker) {
                            break;
                        }
                    } catch (err) {
                        console.warn('åˆ†é¡µæŸ¥è¯¢å¤±è´¥ï¼Œä½¿ç”¨å·²åŠ è½½çš„æ•°æ®:', err);
                        console.log('å·²åŠ è½½çš„è®°å½•æ•°ï¼ˆå»é‡åï¼‰:', allRecords.length);
                        break; // å¦‚æœåˆ†é¡µæŸ¥è¯¢å¤±è´¥ï¼Œä½¿ç”¨å·²åŠ è½½çš„æ•°æ®
                    }
                }

                console.log(`åº“å­˜æ•°æ®åŠ è½½å®Œæˆï¼Œå…± ${allRecords.length} æ¡è®°å½•ï¼ˆå·²å»é‡ï¼‰`);

                // å¤„ç†å“åº”æ•°æ®ï¼ˆå·²æŒ‰ barcode æ’åºï¼‰
                inventoryData = allRecords.map(record => {
                    const fields = record.fields || {};
                    return {
                        id: record.recordName || record.recordID?.recordName || '',
                        barcode: fields.barcode?.value || '',
                        name: fields.name?.value || '',
                        brand: fields.brand?.value || '',
                        model: fields.model?.value || '',
                        serialNumber: fields.serialNumber?.value || '',
                        status: fields.status?.value || 'åœ¨åº“',
                        category: fields.category?.value || '',
                        categoryCode: fields.categoryCode?.value || '',
                        purchaseDate: fields.purchaseDate?.value || null,
                        assetNumber: fields.assetNumber?.value || '',
                        location: fields.location?.value || '',
                        notes: fields.notes?.value || ''
                    };
                });
                
                // å†æ¬¡åŸºäºæ¡ç å»é‡ï¼ˆä¿æŒ barcode æ’åºé¡ºåºï¼‰
                // ä½¿ç”¨ Map ä¿æŒæ’å…¥é¡ºåºï¼Œç¡®ä¿å»é‡åä»ç„¶æŒ‰ barcode æ’åº
                const barcodeMap = new Map();
                const itemsWithBarcode = [];
                const itemsWithoutBarcode = [];
                
                inventoryData.forEach(item => {
                    if (!item.barcode) {
                        // æ²¡æœ‰æ¡ç çš„è®°å½•å•ç‹¬å¤„ç†
                        itemsWithoutBarcode.push(item);
                    } else if (!barcodeMap.has(item.barcode)) {
                        // ç¬¬ä¸€æ¬¡å‡ºç°çš„æ¡ç ï¼Œä¿ç•™ï¼ˆä¿æŒé¡ºåºï¼‰
                        barcodeMap.set(item.barcode, item);
                        itemsWithBarcode.push(item);
                    } else {
                        console.warn('å‘ç°é‡å¤æ¡ç :', item.barcode);
                    }
                });
                
                // åˆå¹¶ï¼šå…ˆæ˜¯æœ‰æ¡ç çš„ï¼ˆå·²æ’åºï¼‰ï¼Œç„¶åæ˜¯æ²¡æœ‰æ¡ç çš„
                inventoryData = itemsWithBarcode.concat(itemsWithoutBarcode);
                
                console.log(`æœ€ç»ˆåº“å­˜æ•°æ®: ${inventoryData.length} æ¡ï¼ˆåŸºäºæ¡ç å»é‡åï¼‰`);

                updateInventoryStats();
                // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰æ•°æ®ï¼Œå¹¶é€‰ä¸­"æ€»ç‰©å“æ•°"å¡ç‰‡
                filterInventoryByStatus('all');
                updateLastUpdate();
            } catch (error) {
                console.error('åŠ è½½åº“å­˜æ•°æ®å¤±è´¥:', error);
                let errorMsg = 'åŠ è½½åº“å­˜æ•°æ®å¤±è´¥: ' + (error.message || error);
                if (error.ckErrorCode) {
                    errorMsg += ' (é”™è¯¯ä»£ç : ' + error.ckErrorCode + ')';
                }
                showError('inventoryContent', errorMsg);
            }
        }

        // æ›´æ–°åº“å­˜ç»Ÿè®¡
        function updateInventoryStats() {
            document.getElementById('totalInventory').textContent = inventoryData.length;
            document.getElementById('inStockCount').textContent = 
                inventoryData.filter(item => item.status === 'åœ¨åº“').length;
            document.getElementById('outStockCount').textContent = 
                inventoryData.filter(item => item.status === 'å‡ºåº“').length;
            document.getElementById('damagedCount').textContent = 
                inventoryData.filter(item => item.status === 'æŸå').length;
        }

        // æ˜¾ç¤ºåº“å­˜æ•°æ®
        function displayInventory(filteredData = null) {
            const data = filteredData || inventoryData;
            // ä¿å­˜å½“å‰æ˜¾ç¤ºçš„ç­›é€‰æ•°æ®ï¼Œç”¨äºè¯¦æƒ…æ˜¾ç¤º
            filteredInventoryData = data;
            const contentDiv = document.getElementById('inventoryContent');

            if (data.length === 0) {
                contentDiv.innerHTML = '<div class="empty-state"><p>æš‚æ— åº“å­˜æ•°æ®</p></div>';
                return;
            }

            let html = '<table class="data-table"><thead><tr>';
            html += '<th>æ¡ç </th><th>åç§°</th><th>å“ç‰Œ</th><th>å‹å·</th><th>çŠ¶æ€</th><th>ä½ç½®</th><th>å¤‡æ³¨</th>';
            html += '</tr></thead><tbody>';

            data.forEach((item, index) => {
                const statusClass = item.status === 'åœ¨åº“' ? 'status-inStock' : 
                                   item.status === 'å‡ºåº“' ? 'status-outStock' : 'status-damaged';
                // ä½¿ç”¨æ¡ç ä½œä¸ºæ ‡è¯†ç¬¦ï¼Œæ›´å¯é 
                const barcode = item.barcode || '';
                // ä½¿ç”¨ data å±æ€§å­˜å‚¨æ¡ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
                html += `<tr onclick="showInventoryDetailByBarcode(this.getAttribute('data-barcode'))" data-barcode="${escapeHtml(barcode)}">`;
                html += `<td>${escapeHtml(formatField(item.barcode))}</td>`;
                html += `<td>${escapeHtml(formatField(item.name))}</td>`;
                html += `<td>${escapeHtml(formatField(item.brand))}</td>`;
                html += `<td>${escapeHtml(formatField(item.model))}</td>`;
                html += `<td><span class="status-badge ${statusClass}">${escapeHtml(item.status)}</span></td>`;
                html += `<td>${escapeHtml(formatField(item.location))}</td>`;
                html += `<td>${escapeHtml(formatField(item.notes))}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            contentDiv.innerHTML = html;
        }

        // æŒ‰çŠ¶æ€ç­›é€‰åº“å­˜
        function filterInventoryByStatus(status) {
            currentStatusFilter = status;
            
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡çš„é«˜äº®çŠ¶æ€
            document.querySelectorAll('.stat-card.clickable').forEach(card => {
                card.classList.remove('active');
            });
            
            if (status === 'all') {
                document.getElementById('statCardAll').classList.add('active');
            } else if (status === 'åœ¨åº“') {
                document.getElementById('statCardInStock').classList.add('active');
            } else if (status === 'å‡ºåº“') {
                document.getElementById('statCardOutStock').classList.add('active');
            } else if (status === 'æŸå') {
                document.getElementById('statCardDamaged').classList.add('active');
            }
            
            // åº”ç”¨çŠ¶æ€ç­›é€‰
            let filtered = inventoryData;
            if (status !== 'all') {
                filtered = inventoryData.filter(item => item.status === status);
            }
            
            // å¦‚æœæœç´¢æ¡†æœ‰å†…å®¹ï¼ŒåŒæ—¶åº”ç”¨æœç´¢ç­›é€‰
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.barcode && item.barcode.toLowerCase().includes(searchTerm)) ||
                    (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
                    (item.model && item.model.toLowerCase().includes(searchTerm)) ||
                    (item.serialNumber && item.serialNumber.toLowerCase().includes(searchTerm))
                );
            }
            
            displayInventory(filtered);
        }

        // ç­›é€‰åº“å­˜ï¼ˆæœç´¢ï¼‰
        function filterInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            let filtered = inventoryData;
            
            // åº”ç”¨çŠ¶æ€ç­›é€‰
            if (currentStatusFilter !== 'all') {
                filtered = inventoryData.filter(item => item.status === currentStatusFilter);
            }
            
            // åº”ç”¨æœç´¢ç­›é€‰
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.barcode && item.barcode.toLowerCase().includes(searchTerm)) ||
                    (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
                    (item.model && item.model.toLowerCase().includes(searchTerm)) ||
                    (item.serialNumber && item.serialNumber.toLowerCase().includes(searchTerm))
                );
            }
            
            displayInventory(filtered);
        }

        // åŠ è½½å‡ºå…¥åº“è®°å½•
        async function loadStockRecords() {
            const contentDiv = document.getElementById('stockRecordsContent');
            contentDiv.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å‡ºå…¥åº“è®°å½•</div>';

            try {
                // åˆ†é¡µè·å–å…¨éƒ¨å‡ºå…¥åº“è®°å½•
                const records = await fetchAllRecordsPaged({
                    recordType: 'StockRecord',
                    filterBy: [],
                    sortBy: [{ fieldName: 'date', ascending: false }],
                    resultsLimit: 400
                });
                // è°ƒè¯•ï¼šæ‰“å°å‰å‡ æ¡å‡ºå…¥åº“è®°å½•çš„åŸå§‹å­—æ®µï¼Œæ–¹ä¾¿ç¡®è®¤ images / imageNames å­—æ®µç»“æ„
                console.log('è°ƒè¯•: åŸå§‹ StockRecord CKRecord ç¤ºä¾‹(å‰3æ¡):');
                records.slice(0, 3).forEach((r, idx) => {
                    console.log(`StockRecord[${idx}] recordID=`, r.recordName || r.recordID?.recordName, 'fields=', r.fields);
                });

                stockRecordsData = records.map(record => {
                    const fields = record.fields || {};
                    return {
                        id: record.recordName || record.recordID?.recordName || '',
                        recordNumber: fields.recordNumber?.value || '',
                        type: fields.type?.value || '',
                        itemIDs: fields.itemIDs?.value || [],
                        date: fields.date?.value || new Date(),
                        eventStartDate: fields.eventStartDate?.value || null,
                        eventEndDate: fields.eventEndDate?.value || null,
                        notes: fields.notes?.value || '',
                        eventInfo: fields.eventInfo?.value || '',
                        eventLocation: fields.eventLocation?.value || '',
                        boxCount: fields.boxCount?.value || 0,
                        operatorUsername: fields.operatorUsername?.value || 'æœªçŸ¥ç”¨æˆ·',
                        // iOS ä¸­ StockRecord é‡Œæœ‰ images:[String]ï¼ˆURL å­—ç¬¦ä¸²ï¼‰ï¼Œä¼˜å…ˆä½¿ç”¨è¿™ä¸ª
                        images: Array.isArray(fields.images?.value) ? fields.images.value : []
                    };
                });

                updateStockStats();
                displayStockRecords();
                updateLastUpdate();
            } catch (error) {
                console.error('åŠ è½½å‡ºå…¥åº“è®°å½•å¤±è´¥:', error);
                let errorMsg = 'åŠ è½½å‡ºå…¥åº“è®°å½•å¤±è´¥: ' + (error.message || error);
                if (error.ckErrorCode) {
                    errorMsg += ' (é”™è¯¯ä»£ç : ' + error.ckErrorCode + ')';
                }
                showError('stockRecordsContent', errorMsg);
            }
        }

        // æ›´æ–°å‡ºå…¥åº“ç»Ÿè®¡
        function updateStockStats() {
            document.getElementById('totalStockRecords').textContent = stockRecordsData.length;
            document.getElementById('stockInCount').textContent = 
                stockRecordsData.filter(record => record.type === 'stockIn').length;
            document.getElementById('stockOutCount').textContent = 
                stockRecordsData.filter(record => record.type === 'stockOut').length;
        }

        // æ˜¾ç¤ºå‡ºå…¥åº“è®°å½•
        function displayStockRecords(filteredData = null) {
            const data = filteredData || stockRecordsData;
            const contentDiv = document.getElementById('stockRecordsContent');

            if (data.length === 0) {
                contentDiv.innerHTML = '<div class="empty-state"><p>æš‚æ— å‡ºå…¥åº“è®°å½•</p></div>';
                return;
            }

            let html = '<div class="item-list">';
            const timestamp = Date.now();

            data.forEach((record, index) => {
                const typeClass = record.type === 'stockIn' ? 'type-stockIn' : 'type-stockOut';
                const typeText = record.type === 'stockIn' ? 'å…¥åº“' : 'å‡ºåº“';
                const date = new Date(record.date).toLocaleString('zh-CN');
                const barcodeId = record.recordNumber ? `stockbarcode-${index}-${timestamp}` : null;

                html += `<div class="item-card" onclick="showStockRecordDetail(${index})">`;
                html += '<div class="item-header">';
                // å·¦ä¾§ï¼šä»…çŠ¶æ€æ ‡è¯†
                html += `<div style="display:flex; align-items:center; gap:10px; min-width:0;">`;
                html += `<span class="type-badge ${typeClass}">${typeText}</span>`;
                html += `</div>`;
                // å³ä¾§ï¼šè®°å½•ç¼–å·æ¡å½¢ç 
                if (barcodeId) {
                    html += `<div class="barcode-container" style="margin-left: auto;"><svg id="${barcodeId}" class="barcode-image" style="max-width: 120px;"></svg><span class="barcode-text">${escapeHtml(record.recordNumber)}</span></div>`;
                } else {
                    html += `<div style="margin-left: auto; color: #6c757d;">æ— </div>`;
                }
                html += '</div>';
                html += '<div class="item-details">';
                html += `<div class="detail-item"><span class="detail-label">æ—¥æœŸ</span><span class="detail-value">${date}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">æ“ä½œå‘˜</span><span class="detail-value">${escapeHtml(formatField(record.operatorUsername))}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">ç‰©å“æ•°é‡</span><span class="detail-value">${record.itemIDs.length}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">ç®±æ•°</span><span class="detail-value">${record.boxCount ? record.boxCount : 'æ— '}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºä¿¡æ¯</span><span class="detail-value">${escapeHtml(formatField(record.eventInfo))}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºåœ°ç‚¹</span><span class="detail-value">${escapeHtml(formatField(record.eventLocation))}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">å¤‡æ³¨</span><span class="detail-value">${escapeHtml(formatField(record.notes))}</span></div>`;
                html += '</div>';
                html += '</div>';
            });

            html += '</div>';
            contentDiv.innerHTML = html;

            // ç”Ÿæˆè®°å½•ç¼–å·æ¡å½¢ç ï¼ˆåˆ—è¡¨é¡µï¼ŒWEBä¸æ‰‹æœºç«¯å‡æ˜¾ç¤ºï¼Œæ‰‹æœºç«¯è‡ªé€‚åº”ï¼‰
            setTimeout(() => {
                data.forEach((record, index) => {
                    if (!record.recordNumber) return;
                    const barcodeId = `stockbarcode-${index}-${timestamp}`;
                    const el = document.getElementById(barcodeId);
                    if (!el) return;
                    try {
                        const isMobile = window.innerWidth <= 576;
                        JsBarcode(el, String(record.recordNumber), {
                            format: "CODE128",
                            width: isMobile ? 1.3 : 2,
                            height: isMobile ? 38 : 48,
                            displayValue: false,
                            margin: 3,
                            background: "#ffffff",
                            lineColor: "#000000"
                        });
                        if (isMobile) {
                            el.removeAttribute('width');
                            el.style.maxWidth = '40vw';
                            el.style.width = '100%';
                            el.style.height = 'auto';
                        } else {
                            el.style.maxWidth = '140px';
                        }
                    } catch (e) {
                        console.warn('ç”Ÿæˆåˆ—è¡¨è®°å½•ç¼–å·æ¡å½¢ç å¤±è´¥:', e);
                    }
                });
            }, 100);
        }

        // ç­›é€‰å‡ºå…¥åº“è®°å½•
        function filterStockRecords() {
            const searchTerm = document.getElementById('stockSearch').value.toLowerCase();
            const filtered = stockRecordsData.filter(record => 
                record.recordNumber.toLowerCase().includes(searchTerm) ||
                record.operatorUsername.toLowerCase().includes(searchTerm) ||
                (record.eventInfo && record.eventInfo.toLowerCase().includes(searchTerm))
            );
            displayStockRecords(filtered);
        }

        // åŠ è½½é¢„å‡ºåº“æ–¹æ¡ˆ
        async function loadPreOutboundDesigns() {
            const contentDiv = document.getElementById('preOutboundContent');
            contentDiv.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½é¢„å‡ºåº“æ–¹æ¡ˆ</div>';

            try {
                // åˆ†é¡µè·å–å…¨éƒ¨é¢„å‡ºåº“æ–¹æ¡ˆ
                const records = await fetchAllRecordsPaged({
                    recordType: 'PreOutboundDesign',
                    filterBy: [],
                    sortBy: [{ fieldName: 'designDate', ascending: false }],
                    resultsLimit: 400
                });
                preOutboundData = records.map(record => {
                    const fields = record.fields || {};
                    let items = [];
                    if (fields.items?.value) {
                        try {
                            items = JSON.parse(fields.items.value);
                        } catch (e) {
                            console.error('è§£æ items å¤±è´¥:', e);
                        }
                    }

                    return {
                        id: record.recordName || record.recordID?.recordName || '',
                        name: fields.name?.value || '',
                        items: items,
                        designDate: fields.designDate?.value || new Date(),
                        eventStartDate: fields.eventStartDate?.value || new Date(),
                        eventEndDate: fields.eventEndDate?.value || new Date(),
                        eventInfo: fields.eventInfo?.value || '',
                        eventLocation: fields.eventLocation?.value || '',
                        creator: fields.creator?.value || 'æœªçŸ¥ç”¨æˆ·',
                        barcode: fields.barcode?.value || ''
                    };
                });

                updatePreOutboundStats();
                displayPreOutboundDesigns();
                updateLastUpdate();
            } catch (error) {
                console.error('åŠ è½½é¢„å‡ºåº“æ–¹æ¡ˆå¤±è´¥:', error);
                let errorMsg = 'åŠ è½½é¢„å‡ºåº“æ–¹æ¡ˆå¤±è´¥: ' + (error.message || error);
                if (error.ckErrorCode) {
                    errorMsg += ' (é”™è¯¯ä»£ç : ' + error.ckErrorCode + ')';
                }
                showError('preOutboundContent', errorMsg);
            }
        }

        // æ›´æ–°é¢„å‡ºåº“ç»Ÿè®¡
        function updatePreOutboundStats() {
            document.getElementById('totalPreOutbound').textContent = preOutboundData.length;
        }

        // æ˜¾ç¤ºé¢„å‡ºåº“æ–¹æ¡ˆ
        function displayPreOutboundDesigns(filteredData = null) {
            const data = filteredData || preOutboundData;
            const contentDiv = document.getElementById('preOutboundContent');

            if (data.length === 0) {
                contentDiv.innerHTML = '<div class="empty-state"><p>æš‚æ— é¢„å‡ºåº“æ–¹æ¡ˆ</p></div>';
                return;
            }

            let html = '<div class="item-list">';
            const timestamp = Date.now();

            data.forEach((design, index) => {
                const designDate = new Date(design.designDate).toLocaleString('zh-CN');
                const eventStart = new Date(design.eventStartDate).toLocaleDateString('zh-CN');
                const eventEnd = new Date(design.eventEndDate).toLocaleDateString('zh-CN');
                const displayBarcode = getDesignBarcode(design);
                const barcodeId = `prebarcode-${index}-${timestamp}`;

                html += `<div class="item-card" onclick="showPreOutboundDetail(${index})">`;
                html += '<div class="item-header">';
                html += `<div class="item-title">${escapeHtml(formatField(design.name))}</div>`;
                html += `<div class="barcode-container" style="margin-left: auto;"><svg id="${barcodeId}" class="barcode-image" style="max-width: 120px;"></svg><span class="barcode-text">${escapeHtml(displayBarcode)}</span></div>`;
                html += '</div>';
                html += '<div class="item-details">';
                html += `<div class="detail-item"><span class="detail-label">åˆ›å»ºæ—¥æœŸ</span><span class="detail-value">${designDate}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">åˆ›å»ºè€…</span><span class="detail-value">${escapeHtml(formatField(design.creator))}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">ç‰©å“æ•°é‡</span><span class="detail-value">${design.items.length}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºæ—¶é—´</span><span class="detail-value">${eventStart} - ${eventEnd}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºä¿¡æ¯</span><span class="detail-value">${escapeHtml(formatField(design.eventInfo))}</span></div>`;
                html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºåœ°ç‚¹</span><span class="detail-value">${escapeHtml(formatField(design.eventLocation))}</span></div>`;
                html += '</div>';
                html += '</div>';
            });

            html += '</div>';
            contentDiv.innerHTML = html;
            
            // ç”Ÿæˆæ¡å½¢ç 
            setTimeout(() => {
                data.forEach((design, index) => {
                    const displayBarcode = getDesignBarcode(design);
                    const barcodeId = `prebarcode-${index}-${timestamp}`;
                    const barcodeElement = document.getElementById(barcodeId);
                    if (barcodeElement) {
                        try {
                            const isMobile = window.innerWidth <= 576;
                            JsBarcode(barcodeElement, String(displayBarcode), {
                                format: "CODE128",
                                width: isMobile ? 1.3 : 2,
                                height: isMobile ? 38 : 48,
                                displayValue: false,
                                margin: 3,
                                background: "#ffffff",
                                lineColor: "#000000"
                            });
                            if (isMobile) {
                                barcodeElement.removeAttribute('width');
                                barcodeElement.style.maxWidth = '40vw';
                                barcodeElement.style.width = '100%';
                                barcodeElement.style.height = 'auto';
                            } else {
                                barcodeElement.style.maxWidth = '140px';
                            }
                        } catch (e) {
                            console.error('ç”Ÿæˆæ¡å½¢ç å¤±è´¥:', e);
                        }
                    }
                });
            }, 100);
        }

        // ç­›é€‰é¢„å‡ºåº“æ–¹æ¡ˆ
        function filterPreOutbound() {
            const searchTerm = document.getElementById('preOutboundSearch').value.toLowerCase();
            const filtered = preOutboundData.filter(design => 
                design.name.toLowerCase().includes(searchTerm) ||
                design.creator.toLowerCase().includes(searchTerm) ||
                (design.eventInfo && design.eventInfo.toLowerCase().includes(searchTerm)) ||
                (design.barcode && design.barcode.toLowerCase().includes(searchTerm))
            );
            displayPreOutboundDesigns(filtered);
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('zh-CN');
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ ¼å¼åŒ–å­—æ®µå€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤º"æ— "
        function formatField(value, defaultValue = 'æ— ') {
            if (!value || value === '' || value === null || value === undefined) {
                return defaultValue;
            }
            return value;
        }

        // ç­›é€‰åŠŸèƒ½å ä½
        function showInventoryFilters() {
            alert('ç­›é€‰åŠŸèƒ½å¼€å‘ä¸­...');
        }

        function showStockFilters() {
            alert('ç­›é€‰åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // é€šè¿‡æ¡ç æ˜¾ç¤ºåº“å­˜ç‰©å“è¯¦æƒ…
        function showInventoryDetailByBarcode(barcode) {
            // å…ˆä»ç­›é€‰åçš„æ•°æ®ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™ä»å…¨éƒ¨æ•°æ®ä¸­æŸ¥æ‰¾
            let item = filteredInventoryData ? filteredInventoryData.find(i => i.barcode === barcode) : null;
            if (!item) {
                item = inventoryData.find(i => i.barcode === barcode);
            }
            
            if (!item) {
                console.error('æœªæ‰¾åˆ°æ¡ç å¯¹åº”çš„ç‰©å“:', barcode);
                return;
            }
            
            showInventoryDetailItem(item);
        }

        // æ˜¾ç¤ºåº“å­˜ç‰©å“è¯¦æƒ…ï¼ˆä¿ç•™åŸå‡½æ•°ä»¥å…¼å®¹ï¼‰
        function showInventoryDetail(index) {
            const item = inventoryData[index];
            if (!item) return;
            showInventoryDetailItem(item);
        }

        // æ˜¾ç¤ºåº“å­˜ç‰©å“è¯¦æƒ…çš„æ ¸å¿ƒå‡½æ•°
        function showInventoryDetailItem(item) {
            if (!item) return;

            document.getElementById('modalTitle').textContent = 'åº“å­˜è¯¦æƒ…';
            
            let html = '<div class="detail-section">';
            html += '<h3>åŸºæœ¬ä¿¡æ¯</h3>';
            html += '<div class="detail-grid">';
            html += `<div class="detail-item"><span class="detail-label">æ¡ç </span><span class="detail-value">${escapeHtml(formatField(item.barcode))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">åç§°</span><span class="detail-value">${escapeHtml(formatField(item.name))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">å“ç‰Œ</span><span class="detail-value">${escapeHtml(formatField(item.brand))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">å‹å·</span><span class="detail-value">${escapeHtml(formatField(item.model))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">åºåˆ—å·</span><span class="detail-value">${escapeHtml(formatField(item.serialNumber))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">çŠ¶æ€</span><span class="detail-value"><span class="status-badge ${item.status === 'åœ¨åº“' ? 'status-inStock' : item.status === 'å‡ºåº“' ? 'status-outStock' : 'status-damaged'}">${escapeHtml(item.status)}</span></span></div>`;
            html += `<div class="detail-item"><span class="detail-label">åˆ†ç±»</span><span class="detail-value">${escapeHtml(formatField(item.category))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">åˆ†ç±»ä»£ç </span><span class="detail-value">${escapeHtml(formatField(item.categoryCode))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">èµ„äº§ç¼–å·</span><span class="detail-value">${escapeHtml(formatField(item.assetNumber))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">ä½ç½®</span><span class="detail-value">${escapeHtml(formatField(item.location))}</span></div>`;
            if (item.purchaseDate) {
                const purchaseDate = new Date(item.purchaseDate).toLocaleDateString('zh-CN');
                html += `<div class="detail-item"><span class="detail-label">è´­ä¹°æ—¥æœŸ</span><span class="detail-value">${purchaseDate}</span></div>`;
            } else {
                html += `<div class="detail-item"><span class="detail-label">è´­ä¹°æ—¥æœŸ</span><span class="detail-value">æ— </span></div>`;
            }
            html += `<div class="detail-item" style="grid-column: 1 / -1;"><span class="detail-label">å¤‡æ³¨</span><span class="detail-value">${escapeHtml(formatField(item.notes))}</span></div>`;
            html += '</div></div>';

            // æ˜¾ç¤ºæ¡å½¢ç 
            html += '<div class="detail-section">';
            html += '<h3>æ¡å½¢ç </h3>';
            html += '<div style="text-align: center; padding: 20px;">';
            html += `<svg id="modal-barcode" style="max-width: 300px;"></svg>`;
            html += `<div style="margin-top: 10px; font-family: monospace; color: #6c757d;">${escapeHtml(item.barcode)}</div>`;
            html += '</div></div>';

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailModal').style.display = 'block';

            // ç”Ÿæˆæ¡å½¢ç 
            setTimeout(() => {
                const barcodeElement = document.getElementById('modal-barcode');
                if (barcodeElement && item.barcode) {
                    try {
                        JsBarcode(barcodeElement, item.barcode, {
                            format: "CODE128",
                            width: 3,
                            height: 80,
                            displayValue: false,
                            margin: 10,
                            background: "#ffffff",
                            lineColor: "#000000"
                        });
                    } catch (e) {
                        console.error('ç”Ÿæˆæ¡å½¢ç å¤±è´¥:', e);
                    }
                }
            }, 100);
        }

        // æ˜¾ç¤ºå‡ºå…¥åº“è®°å½•è¯¦æƒ…
        async function showStockRecordDetail(index) {
            const record = stockRecordsData[index];
            if (!record) return;

            document.getElementById('modalTitle').textContent = 'å‡ºå…¥åº“è®°å½•è¯¦æƒ…';
            
            let html = '<div class="detail-section">';
            html += '<h3>è®°å½•ä¿¡æ¯</h3>';
            html += '<div class="detail-grid">';
            html += `<div class="detail-item full-row-mobile"><span class="detail-label">è®°å½•ç¼–å·</span><span class="detail-value">${escapeHtml(formatField(record.recordNumber))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">ç±»å‹</span><span class="detail-value"><span class="type-badge ${record.type === 'stockIn' ? 'type-stockIn' : 'type-stockOut'}">${record.type === 'stockIn' ? 'å…¥åº“' : 'å‡ºåº“'}</span></span></div>`;
            html += `<div class="detail-item"><span class="detail-label">æ—¥æœŸ</span><span class="detail-value">${new Date(record.date).toLocaleString('zh-CN')}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">æ“ä½œå‘˜</span><span class="detail-value">${escapeHtml(formatField(record.operatorUsername))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">ç‰©å“æ•°é‡</span><span class="detail-value">${record.itemIDs.length}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">ç®±æ•°</span><span class="detail-value">${record.boxCount ? record.boxCount : 'æ— '}</span></div>`;
            if (record.eventStartDate) {
                html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºå¼€å§‹æ—¥æœŸ</span><span class="detail-value">${new Date(record.eventStartDate).toLocaleDateString('zh-CN')}</span></div>`;
            } else {
                html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºå¼€å§‹æ—¥æœŸ</span><span class="detail-value">æ— </span></div>`;
            }
            if (record.eventEndDate) {
                html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºç»“æŸæ—¥æœŸ</span><span class="detail-value">${new Date(record.eventEndDate).toLocaleDateString('zh-CN')}</span></div>`;
            } else {
                html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºç»“æŸæ—¥æœŸ</span><span class="detail-value">æ— </span></div>`;
            }
            html += `<div class="detail-item" style="grid-column: 1 / -1;"><span class="detail-label">æ¼”å‡ºä¿¡æ¯</span><span class="detail-value">${escapeHtml(formatField(record.eventInfo))}</span></div>`;
            html += `<div class="detail-item" style="grid-column: 1 / -1;"><span class="detail-label">æ¼”å‡ºåœ°ç‚¹</span><span class="detail-value">${escapeHtml(formatField(record.eventLocation))}</span></div>`;
            html += `<div class="detail-item" style="grid-column: 1 / -1;"><span class="detail-label">å¤‡æ³¨</span><span class="detail-value">${escapeHtml(formatField(record.notes))}</span></div>`;
            html += '</div></div>';

            // æ˜¾ç¤ºè®°å½•ç¼–å·æ¡å½¢ç 
            html += '<div class="detail-section">';
            html += '<h3>è®°å½•ç¼–å·æ¡å½¢ç </h3>';
            html += '<div style="text-align: center; padding: 20px;">';
            html += `<svg id="stockrecord-barcode" style="max-width: 100%;"></svg>`;
            html += `<div style="margin-top: 10px; font-family: monospace; color: #6c757d;">${escapeHtml(formatField(record.recordNumber))}</div>`;
            html += '</div></div>';

            // ç…§ç‰‡å ä½åŒºåŸŸï¼ˆæ ¹æ® CloudKit ä¸­ recordType=image & CKAsset æ˜¾ç¤ºï¼‰
            html += '<div class="detail-section" id="photos-section" style="display:none;">';
            html += '<h3>ç›¸å…³ç…§ç‰‡</h3>';
            html += '<div id="photos-container" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;"></div>';
            html += '</div>';

            // åŠ è½½ç‰©å“åˆ—è¡¨
            html += '<div class="detail-section">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            html += '<h3 style="margin: 0;">ç‰©å“åˆ—è¡¨ (' + record.itemIDs.length + ' ä»¶)</h3>';
            html += '<div class="view-toggle">';
            html += '<button class="view-btn" onclick="switchItemsView(\'detail\', \'stock\')">è¯¦ç»†åˆ—è¡¨</button>';
            html += '<button class="view-btn active" onclick="switchItemsView(\'statistics\', \'stock\')">æŒ‰å“ç‰Œå‹å·ç»Ÿè®¡</button>';
            html += '</div>';
            html += '</div>';
            html += '<div class="items-list" id="itemsList-stock">';
            html += '<div class="loading">æ­£åœ¨åŠ è½½ç‰©å“åˆ—è¡¨...</div>';
            html += '</div></div>';

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailModal').style.display = 'block';

            // ç”Ÿæˆè®°å½•ç¼–å·æ¡å½¢ç ï¼ˆä¸åº“å­˜è¯¦æƒ…ä¸€è‡´çš„æ¸²æŸ“æ–¹å¼ï¼‰
            setTimeout(() => {
                const el = document.getElementById('stockrecord-barcode');
                if (el && record.recordNumber) {
                    try {
                        const isMobile = window.innerWidth <= 576;
                        JsBarcode(el, String(record.recordNumber), {
                            format: "CODE128",
                            width: isMobile ? 1.5 : 3,
                            height: isMobile ? 50 : 80,
                            displayValue: false,
                            margin: 10,
                            background: "#ffffff",
                            lineColor: "#000000"
                        });
                        if (isMobile) {
                            // ç§»é™¤å›ºå®šå®½åº¦ï¼Œä½¿ç”¨è‡ªé€‚åº”ç¼©æ”¾é¿å…æº¢å‡º
                            el.removeAttribute('width');
                            el.style.maxWidth = '95vw';
                            el.style.width = '100%';
                            el.style.height = 'auto';
                        } else {
                            el.style.maxWidth = '600px';
                        }
                    } catch (e) {
                        console.warn('ç”Ÿæˆè®°å½•ç¼–å·æ¡å½¢ç å¤±è´¥:', e);
                    }
                }
            }, 100);

            // åŠ è½½å¹¶æ¸²æŸ“ç…§ç‰‡ï¼š
            // 1ï¼‰ä¼˜å…ˆä½¿ç”¨ StockRecord çš„ images:[String]ï¼ˆä¸ iOS CloudKitManager ä¸€è‡´ï¼‰
            // 2ï¼‰è‹¥æ²¡æœ‰ imagesï¼Œå†å›é€€æŸ¥è¯¢ Image è®°å½•ï¼ˆrecordType=Image, relatedRecordID = StockRecord.idï¼‰
            (async () => {
                try {
                    const photosSection = document.getElementById('photos-section');
                    const photosContainer = document.getElementById('photos-container');
                    if (!photosSection || !photosContainer) return;

                    let urls = Array.isArray(record.images) ? record.images
                        .map(String)
                        // è¿‡æ»¤æ‰æœ¬åœ° file:// è·¯å¾„ï¼Œåªä¿ç•™å¯åœ¨ Web è®¿é—®çš„ URL
                        .filter(u => !u.startsWith('file://')) : [];

                    // è°ƒè¯•ï¼šæ‰“å°å½“å‰è®°å½•çš„ images å­—æ®µ
                    console.log('è°ƒè¯•: å½“å‰å‡ºå…¥åº“è®°å½•çš„ images å­—æ®µ:', record.recordNumber, record.images);

                    if (!urls.length && record.id) {
                        const imageQuery = {
                            recordType: 'Image',
                            filterBy: [{
                                fieldName: 'relatedRecordID',
                                comparator: 'EQUALS',
                                fieldValue: { value: record.id }
                            }]
                        };
                        const resp = await cloudKit.publicCloudDatabase.performQuery(imageQuery);
                        console.log('è°ƒè¯•: Image æŸ¥è¯¢ç»“æœ for relatedRecordID =', record.id, resp);
                        if (!(resp.hasErrors && resp.errors && resp.errors.length > 0)) {
                            const imageRecords = resp.records || [];
                            urls = imageRecords.map(imgRecord => {
                                const assetField = imgRecord.fields?.asset;
                                if (!assetField) return null;
                                const asset = assetField.value || assetField;
                                const url = asset.downloadURL || asset.url || asset.fileDownloadURL || asset.fileURL || asset.assetURL;
                                if (!url) return null;
                                const urlStr = String(url);
                                if (urlStr.startsWith('file://')) return null;
                                return urlStr;
                            }).filter(u => u !== null);
                        }
                    }

                    if (!urls.length) return;

                    photosSection.style.display = 'block';
                    let htmlPhotos = '';
                    urls.forEach(url => {
                        const safeUrl = escapeHtml(String(url));
                        htmlPhotos += `<a href="${safeUrl}" target="_blank" rel="noopener" style="display:block;border:1px solid #e1e8ed;border-radius:6px;overflow:hidden;background:#fff;">`;
                        htmlPhotos += `<img src="${safeUrl}" alt="è®°å½•ç…§ç‰‡" style="width:100%;height:100%;object-fit:cover;display:block;aspect-ratio:4/3;" onerror="this.style.display='none';">`;
                        htmlPhotos += `</a>`;
                    });
                    photosContainer.innerHTML = htmlPhotos;
                } catch (e) {
                    console.warn('åŠ è½½ç…§ç‰‡å¤±è´¥:', e);
                }
            })();

            // åŠ è½½ç‰©å“è¯¦æƒ…ï¼ˆä¸ iOS ç‰ˆæœ¬é€»è¾‘ä¸€è‡´ï¼šç›´æ¥ä» CloudKit æŸ¥è¯¢ï¼‰
            (async () => {
                try {
                    if (record.itemIDs.length > 0) {
                        // æ˜¾ç¤ºåŠ è½½ä¸­
                        const itemsListContainer = document.querySelector('.items-list');
                        if (itemsListContainer) {
                            itemsListContainer.innerHTML = '<div class="loading">æ­£åœ¨ä» CloudKit åŠ è½½ç‰©å“ä¿¡æ¯...</div>';
                        }

                        // ä½¿ç”¨ CloudKit ç›´æ¥æŸ¥è¯¢ç‰©å“ï¼ˆä¸ iOS ç‰ˆæœ¬é€»è¾‘ä¸€è‡´ï¼‰
                        // CloudKit JS å¯èƒ½ä¸æ”¯æŒ IN æ“ä½œç¬¦ï¼Œæ”¹ç”¨é€ä¸ªæŸ¥è¯¢æˆ–æ‰¹é‡å¹¶è¡ŒæŸ¥è¯¢
                        
                        // å¹¶è¡ŒæŸ¥è¯¢æ‰€æœ‰æ¡ç ï¼ˆæé«˜æ•ˆç‡ï¼‰
                        const queryPromises = record.itemIDs.map(async (barcode) => {
                            try {
                                const query = {
                                    recordType: 'Inventory',
                                    filterBy: [{
                                        fieldName: 'barcode',
                                        comparator: 'EQUALS',
                                        fieldValue: { value: barcode }
                                    }]
                                };

                                const response = await cloudKit.publicCloudDatabase.performQuery(query);
                                
                                if (response.hasErrors && response.errors.length > 0) {
                                    console.warn(`æŸ¥è¯¢æ¡ç  ${barcode} å¤±è´¥:`, response.errors[0].message);
                                    return null;
                                }

                                const records = response.records || [];
                                if (records.length > 0) {
                                    const record = records[0]; // å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„è®°å½•
                                    const fields = record.fields || {};
                                    return {
                                        id: record.recordName || record.recordID?.recordName || '',
                                        barcode: fields.barcode?.value || '',
                                        name: fields.name?.value || '',
                                        brand: fields.brand?.value || '',
                                        model: fields.model?.value || '',
                                        serialNumber: fields.serialNumber?.value || '',
                                        status: fields.status?.value || 'åœ¨åº“',
                                        category: fields.category?.value || '',
                                        categoryCode: fields.categoryCode?.value || '',
                                        purchaseDate: fields.purchaseDate?.value || null,
                                        assetNumber: fields.assetNumber?.value || '',
                                        location: fields.location?.value || '',
                                        notes: fields.notes?.value || ''
                                    };
                                }
                                return null;
                            } catch (err) {
                                console.warn(`æŸ¥è¯¢æ¡ç  ${barcode} å¼‚å¸¸:`, err);
                                return null;
                            }
                        });

                        // ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ
                        const results = await Promise.all(queryPromises);
                        const allItemsRaw = results.filter(item => item !== null);
                        
                        // å»é‡ï¼šåŸºäºæ¡ç å»é‡ï¼ˆé˜²æ­¢åŒä¸€æ¡ç æŸ¥è¯¢å¤šæ¬¡ï¼‰
                        const barcodeMap = new Map();
                        const allItems = [];
                        allItemsRaw.forEach(item => {
                            if (!barcodeMap.has(item.barcode)) {
                                barcodeMap.set(item.barcode, item);
                                allItems.push(item);
                            }
                        });

                        console.log(`ä» CloudKit æŸ¥è¯¢åˆ° ${allItems.length}/${record.itemIDs.length} ä¸ªç‰©å“`);

                        // æ‰¾å‡ºæœªæ‰¾åˆ°çš„æ¡ç 
                        const foundBarcodes = new Set(allItems.map(item => item.barcode));
                        const missingBarcodes = record.itemIDs.filter(barcode => 
                            !foundBarcodes.has(barcode)
                        );

                        // ä¿å­˜åˆ°å…¨å±€å˜é‡ä»¥ä¾›åˆ‡æ¢è§†å›¾ä½¿ç”¨
                        window.currentItems_stock = allItems;
                        window.currentMissingBarcodes_stock = missingBarcodes;

                        // é»˜è®¤æ˜¾ç¤ºç»Ÿè®¡è§†å›¾
                        renderItemsListView(allItems, missingBarcodes, 'stock', 'statistics');
                    } else {
                        document.querySelector('.items-list').innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">æš‚æ— ç‰©å“</p>';
                    }
                } catch (error) {
                    console.error('åŠ è½½ç‰©å“åˆ—è¡¨å¤±è´¥:', error);
                    const itemsListContainer = document.querySelector('.items-list');
                    if (itemsListContainer) {
                        itemsListContainer.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">åŠ è½½ç‰©å“åˆ—è¡¨å¤±è´¥: ' + error.message + '</p>';
                    }
                }
            })();
        }

        // æ˜¾ç¤ºé¢„å‡ºåº“æ–¹æ¡ˆè¯¦æƒ…
        function showPreOutboundDetail(index) {
            const design = preOutboundData[index];
            if (!design) return;

            document.getElementById('modalTitle').textContent = 'é¢„å‡ºåº“æ–¹æ¡ˆè¯¦æƒ…';
            
            let html = '<div class="detail-section">';
            html += '<h3>æ–¹æ¡ˆä¿¡æ¯</h3>';
            html += '<div class="detail-grid">';
            html += `<div class="detail-item"><span class="detail-label">æ–¹æ¡ˆåç§°</span><span class="detail-value">${escapeHtml(formatField(design.name))}</span></div>`;
            const displayBarcode = getDesignBarcode(design);
            html += `<div class="detail-item"><span class="detail-label">æ¡ç </span><span class="detail-value">${escapeHtml(displayBarcode)}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">åˆ›å»ºæ—¥æœŸ</span><span class="detail-value">${new Date(design.designDate).toLocaleString('zh-CN')}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">åˆ›å»ºè€…</span><span class="detail-value">${escapeHtml(formatField(design.creator))}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">ç‰©å“æ•°é‡</span><span class="detail-value">${design.items.length}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºå¼€å§‹æ—¥æœŸ</span><span class="detail-value">${new Date(design.eventStartDate).toLocaleDateString('zh-CN')}</span></div>`;
            html += `<div class="detail-item"><span class="detail-label">æ¼”å‡ºç»“æŸæ—¥æœŸ</span><span class="detail-value">${new Date(design.eventEndDate).toLocaleDateString('zh-CN')}</span></div>`;
            html += `<div class="detail-item" style="grid-column: 1 / -1;"><span class="detail-label">æ¼”å‡ºä¿¡æ¯</span><span class="detail-value">${escapeHtml(formatField(design.eventInfo))}</span></div>`;
            html += `<div class="detail-item" style="grid-column: 1 / -1;"><span class="detail-label">æ¼”å‡ºåœ°ç‚¹</span><span class="detail-value">${escapeHtml(formatField(design.eventLocation))}</span></div>`;
            html += '</div></div>';

            // æ¡å½¢ç å±•ç¤ºï¼ˆè¯¦æƒ…é¡µï¼‰
            html += '<div class="detail-section">';
            html += '<h3>æ–¹æ¡ˆæ¡å½¢ç </h3>';
            html += '<div style="text-align: center; padding: 20px;">';
            html += `<svg id="preoutbound-barcode" style="max-width: 100%;"></svg>`;
            html += `<div style="margin-top: 10px; font-family: monospace; color: #6c757d;">${escapeHtml(displayBarcode)}</div>`;
            html += '</div></div>';

            // æ˜¾ç¤ºç‰©å“åˆ—è¡¨
            html += '<div class="detail-section">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            html += '<h3 style="margin: 0;">ç‰©å“åˆ—è¡¨ (' + design.items.length + ' ä»¶)</h3>';
            if (design.items.length > 0) {
                html += '<div class="view-toggle">';
                html += '<button class="view-btn" onclick="switchItemsView(\'detail\', \'preoutbound\')">è¯¦ç»†åˆ—è¡¨</button>';
                html += '<button class="view-btn active" onclick="switchItemsView(\'statistics\', \'preoutbound\')">æŒ‰å“ç‰Œå‹å·ç»Ÿè®¡</button>';
                html += '</div>';
            }
            html += '</div>';
            // åˆ—è¡¨å®¹å™¨ï¼Œå†…å®¹åœ¨æ¨¡æ€æ’å…¥åå†æ¸²æŸ“
            html += '<div class="items-list" id="itemsList-preoutbound">';
            if (design.items.length > 0) {
                html += '<div class="loading">æ­£åœ¨åŠ è½½ç‰©å“åˆ—è¡¨...</div>';
            } else {
                html += '<p style="text-align: center; color: #6c757d; padding: 20px;">æš‚æ— ç‰©å“</p>';
            }
            html += '</div></div>';

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailModal').style.display = 'block';

            // ç”Ÿæˆé¢„å‡ºåº“æ–¹æ¡ˆæ¡å½¢ç ï¼ˆWEBä¸æ‰‹æœºå‡æ˜¾ç¤ºï¼Œæ‰‹æœºç«¯è‡ªé€‚åº”ï¼‰
            setTimeout(() => {
                const el = document.getElementById('preoutbound-barcode');
                if (el && displayBarcode) {
                    try {
                        const isMobile = window.innerWidth <= 576;
                        JsBarcode(el, String(displayBarcode), {
                            format: "CODE128",
                            width: isMobile ? 1.5 : 2.5,
                            height: isMobile ? 50 : 70,
                            displayValue: false,
                            margin: 10,
                            background: "#ffffff",
                            lineColor: "#000000"
                        });
                        if (isMobile) {
                            el.removeAttribute('width');
                            el.style.maxWidth = '95vw';
                            el.style.width = '100%';
                            el.style.height = 'auto';
                        } else {
                            el.style.maxWidth = '600px';
                        }
                    } catch (e) {
                        console.warn('ç”Ÿæˆé¢„å‡ºåº“æ–¹æ¡ˆæ¡å½¢ç å¤±è´¥:', e);
                    }
                }
            }, 100);

            // æ¨¡æ€æ’å…¥åå†æ¸²æŸ“ç»Ÿè®¡è§†å›¾ï¼Œç¡®ä¿å®¹å™¨å·²å­˜åœ¨
            if (design.items.length > 0) {
                const items = design.items.map(item => item.inventory || {}).filter(inv => inv && inv.barcode);
                window.currentItems_preoutbound = items;
                window.currentMissingBarcodes_preoutbound = [];
                renderItemsListView(items, [], 'preoutbound', 'statistics');
            }
        }

        // æ¸²æŸ“ç‰©å“åˆ—è¡¨è§†å›¾
        function renderItemsListView(items, missingBarcodes, prefix, viewType) {
            const containerId = `itemsList-${prefix}`;
            const container = document.getElementById(containerId);
            if (!container) return;

            if (viewType === 'detail') {
                // è¯¦ç»†åˆ—è¡¨è§†å›¾
                let html = '<table><thead><tr>';
                html += '<th>æ¡ç </th><th>åç§°</th><th>å“ç‰Œ</th><th>å‹å·</th><th>çŠ¶æ€</th>';
                html += '</tr></thead><tbody>';

                items.forEach(item => {
                    if (!item) return;
                    const status = item.status || 'åœ¨åº“';
                    const statusClass = status === 'åœ¨åº“' ? 'status-inStock' : 
                                      status === 'å‡ºåº“' ? 'status-outStock' : 'status-damaged';
                    
                    html += '<tr>';
                    html += `<td>${escapeHtml(formatField(item.barcode))}</td>`;
                    html += `<td>${escapeHtml(formatField(item.name))}</td>`;
                    html += `<td>${escapeHtml(formatField(item.brand))}</td>`;
                    html += `<td>${escapeHtml(formatField(item.model))}</td>`;
                    html += `<td><span class="status-badge ${statusClass}">${escapeHtml(status)}</span></td>`;
                    html += '</tr>';
                });
                
                // å¦‚æœæœ‰äº›ç‰©å“åœ¨åº“å­˜æ•°æ®ä¸­æ‰¾ä¸åˆ°ï¼Œæ˜¾ç¤ºæ¡ç 
                if (missingBarcodes.length > 0) {
                    missingBarcodes.forEach(barcode => {
                        html += '<tr>';
                        html += `<td>${escapeHtml(barcode)}</td>`;
                        html += '<td colspan="4" style="color: #6c757d; font-style: italic;">ç‰©å“ä¿¡æ¯æœªæ‰¾åˆ°</td>';
                        html += '</tr>';
                    });
                }

                html += '</tbody></table>';
                container.innerHTML = html;
            } else {
                // ç»Ÿè®¡è§†å›¾ï¼ˆæŒ‰å“ç‰Œå‹å·åˆ†ç»„ï¼‰
                const grouped = {};
                
                items.forEach(item => {
                    if (!item) return;
                    const key = `${item.brand || 'æœªçŸ¥å“ç‰Œ'}|${item.model || 'æœªçŸ¥å‹å·'}`;
                    if (!grouped[key]) {
                        grouped[key] = {
                            brand: formatField(item.brand, 'æœªçŸ¥å“ç‰Œ'),
                            model: formatField(item.model, 'æœªçŸ¥å‹å·'),
                            items: []
                        };
                    }
                    grouped[key].items.push(item);
                });

                // å¤„ç†æœªæ‰¾åˆ°çš„ç‰©å“
                if (missingBarcodes.length > 0) {
                    const key = 'æœªæ‰¾åˆ°|ç‰©å“ä¿¡æ¯';
                    if (!grouped[key]) {
                        grouped[key] = {
                            brand: 'æœªæ‰¾åˆ°',
                            model: 'ç‰©å“ä¿¡æ¯',
                            items: []
                        };
                    }
                    missingBarcodes.forEach(barcode => {
                        grouped[key].items.push({ barcode: barcode, name: '', brand: '', model: '', serialNumber: '', status: '' });
                    });
                }

                let html = '<div class="statistics-view">';
                const groups = Object.values(grouped).sort((a, b) => {
                    // å…ˆæŒ‰å“ç‰Œæ’åºï¼Œå†æŒ‰å‹å·æ’åº
                    if (a.brand !== b.brand) {
                        return a.brand.localeCompare(b.brand, 'zh-CN');
                    }
                    return a.model.localeCompare(b.model, 'zh-CN');
                });

                groups.forEach((group, index) => {
                    const groupId = `group-${prefix}-${index}`;
                    html += '<div class="stat-group">';
                    html += `<div class="stat-group-header" onclick="toggleGroup('${groupId}')">`;
                    html += '<div class="stat-group-title">';
                    html += `<span class="expand-icon" id="icon-${groupId}">â–¶</span>`;
                    html += `<strong>${escapeHtml(group.brand)}</strong> - ${escapeHtml(group.model)}`;
                    html += '</div>';
                    html += `<span class="stat-group-count">${group.items.length} ä»¶</span>`;
                    html += '</div>';
                    html += `<div class="stat-group-details" id="${groupId}">`;
                    html += '<div class="stat-group-items">';
                    html += '<table><thead><tr>';
                    html += '<th>æ¡ç </th><th>åç§°</th><th>çŠ¶æ€</th>';
                    html += '</tr></thead><tbody>';

                    group.items.forEach(item => {
                        const status = item.status || 'åœ¨åº“';
                        const statusClass = status === 'åœ¨åº“' ? 'status-inStock' : 
                                          status === 'å‡ºåº“' ? 'status-outStock' : 'status-damaged';
                        
                        html += '<tr>';
                        html += `<td>${escapeHtml(formatField(item.barcode))}</td>`;
                        html += `<td>${escapeHtml(formatField(item.name))}</td>`;
                        html += `<td><span class="status-badge ${statusClass}">${escapeHtml(status)}</span></td>`;
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                    html += '</div></div>';
                    html += '</div>';
                });

                html += '</div>';
                container.innerHTML = html;
            }
        }

        // åˆ‡æ¢ç‰©å“åˆ—è¡¨è§†å›¾
        function switchItemsView(viewType, prefix) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const container = document.getElementById(`itemsList-${prefix}`).closest('.detail-section');
            const buttons = container.querySelectorAll('.view-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // åˆ‡æ¢è§†å›¾
            const items = window[`currentItems_${prefix}`] || [];
            const missingBarcodes = window[`currentMissingBarcodes_${prefix}`] || [];
            renderItemsListView(items, missingBarcodes, prefix, viewType);
        }

        // å±•å¼€/æ”¶èµ·åˆ†ç»„
        function toggleGroup(groupId) {
            const details = document.getElementById(groupId);
            const icon = document.getElementById(`icon-${groupId}`);
            
            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                details.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
            const createModal = document.getElementById('createPreOutboundModal');
            if (event.target === createModal) {
                closeCreatePreOutboundModal();
            }
        }

        // ==================== åˆ›å»ºé¢„å‡ºåº“æ–¹æ¡ˆåŠŸèƒ½ ====================
        let selectedItemsForDesign = []; // å­˜å‚¨é€‰ä¸­çš„ç‰©å“

        // æ‰“å¼€åˆ›å»ºé¢„å‡ºåº“æ–¹æ¡ˆæ¨¡æ€æ¡†
        function openCreatePreOutboundModal() {
            selectedItemsForDesign = [];
            document.getElementById('createPreOutboundModal').style.display = 'block';
            document.getElementById('createPreOutboundForm').reset();
            document.getElementById('designCreator').value = 'admin';
            updateSelectedItemsDisplay();
            loadItemsForSelection();
        }

        // å…³é—­åˆ›å»ºé¢„å‡ºåº“æ–¹æ¡ˆæ¨¡æ€æ¡†
        function closeCreatePreOutboundModal() {
            document.getElementById('createPreOutboundModal').style.display = 'none';
            selectedItemsForDesign = [];
        }

        // åŠ è½½ç‰©å“åˆ—è¡¨ä¾›é€‰æ‹©
        function loadItemsForSelection() {
            const itemListDiv = document.getElementById('itemSelectionList');
            if (!inventoryData || inventoryData.length === 0) {
                itemListDiv.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">è¯·å…ˆåŠ è½½åº“å­˜æ•°æ®</div>';
                return;
            }

            let html = '';
            inventoryData.forEach((item, index) => {
                const isSelected = selectedItemsForDesign.some(selected => selected.barcode === item.barcode);
                html += `<div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #e9ecef; cursor: pointer; ${isSelected ? 'background: #e7f1ff;' : ''}" onclick="toggleItemSelection(${index})">`;
                html += `<input type="checkbox" ${isSelected ? 'checked' : ''} style="margin-right: 10px;" onchange="toggleItemSelection(${index})">`;
                html += `<div style="flex: 1;">`;
                html += `<div style="font-weight: 500;">${escapeHtml(item.name || 'æ— åç§°')}</div>`;
                html += `<div style="font-size: 0.9em; color: #6c757d;">æ¡ç : ${escapeHtml(item.barcode || 'æ— ')} | å“ç‰Œ: ${escapeHtml(item.brand || 'æ— ')} | å‹å·: ${escapeHtml(item.model || 'æ— ')}</div>`;
                html += `</div></div>`;
            });
            itemListDiv.innerHTML = html || '<div style="text-align: center; color: #6c757d; padding: 20px;">æš‚æ— ç‰©å“</div>';
        }

        // åˆ‡æ¢ç‰©å“é€‰æ‹©çŠ¶æ€
        function toggleItemSelection(index) {
            const item = inventoryData[index];
            if (!item) return;

            const existingIndex = selectedItemsForDesign.findIndex(selected => selected.barcode === item.barcode);
            if (existingIndex >= 0) {
                selectedItemsForDesign.splice(existingIndex, 1);
            } else {
                selectedItemsForDesign.push({
                    barcode: item.barcode,
                    name: item.name,
                    brand: item.brand,
                    model: item.model,
                    serialNumber: item.serialNumber
                });
            }
            updateSelectedItemsDisplay();
            loadItemsForSelection(); // åˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
        }

        // æ›´æ–°å·²é€‰ç‰©å“æ˜¾ç¤º
        function updateSelectedItemsDisplay() {
            const countSpan = document.getElementById('selectedItemsCount');
            const displayDiv = document.getElementById('selectedItemsDisplay');
            
            if (countSpan) {
                countSpan.textContent = selectedItemsForDesign.length;
            }

            if (selectedItemsForDesign.length === 0) {
                displayDiv.innerHTML = '<div style="text-align: center; color: #6c757d;">æš‚æ— é€‰æ‹©çš„ç‰©å“</div>';
            } else {
                let html = '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                selectedItemsForDesign.forEach((item, index) => {
                    html += `<div style="display: inline-flex; align-items: center; padding: 6px 12px; background: #e7f1ff; border: 1px solid #b6d4fe; border-radius: 20px; font-size: 0.9em;">`;
                    html += `<span>${escapeHtml(item.name || item.barcode || 'æœªçŸ¥')}</span>`;
                    html += `<span style="margin-left: 8px; cursor: pointer; color: #dc3545; font-weight: bold;" onclick="removeSelectedItem('${escapeHtml(item.barcode)}')" title="ç§»é™¤">Ã—</span>`;
                    html += `</div>`;
                });
                html += '</div>';
                displayDiv.innerHTML = html;
            }
        }

        // ç§»é™¤å·²é€‰ç‰©å“
        function removeSelectedItem(barcode) {
            selectedItemsForDesign = selectedItemsForDesign.filter(item => item.barcode !== barcode);
            updateSelectedItemsDisplay();
            loadItemsForSelection();
        }

        // ç­›é€‰ç‰©å“åˆ—è¡¨
        function filterItemsForSelection() {
            const searchTerm = document.getElementById('itemSearchInput').value.toLowerCase();
            const itemListDiv = document.getElementById('itemSelectionList');
            
            if (!inventoryData || inventoryData.length === 0) {
                return;
            }

            const filtered = inventoryData.filter(item => 
                (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                (item.barcode && item.barcode.toLowerCase().includes(searchTerm)) ||
                (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
                (item.model && item.model.toLowerCase().includes(searchTerm))
            );

            let html = '';
            filtered.forEach((item, index) => {
                const originalIndex = inventoryData.findIndex(orig => orig.barcode === item.barcode);
                const isSelected = selectedItemsForDesign.some(selected => selected.barcode === item.barcode);
                html += `<div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #e9ecef; cursor: pointer; ${isSelected ? 'background: #e7f1ff;' : ''}" onclick="toggleItemSelection(${originalIndex})">`;
                html += `<input type="checkbox" ${isSelected ? 'checked' : ''} style="margin-right: 10px;" onchange="toggleItemSelection(${originalIndex})">`;
                html += `<div style="flex: 1;">`;
                html += `<div style="font-weight: 500;">${escapeHtml(item.name || 'æ— åç§°')}</div>`;
                html += `<div style="font-size: 0.9em; color: #6c757d;">æ¡ç : ${escapeHtml(item.barcode || 'æ— ')} | å“ç‰Œ: ${escapeHtml(item.brand || 'æ— ')} | å‹å·: ${escapeHtml(item.model || 'æ— ')}</div>`;
                html += `</div></div>`;
            });
            itemListDiv.innerHTML = html || '<div style="text-align: center; color: #6c757d; padding: 20px;">æœªæ‰¾åˆ°åŒ¹é…çš„ç‰©å“</div>';
        }

        // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
        async function checkUserAuth() {
            if (!cloudKit) {
                return { authenticated: false, error: 'CloudKit æœªåˆå§‹åŒ–' };
            }

            try {
                const userIdentity = cloudKit.currentUserIdentity;
                if (userIdentity) {
                    return { authenticated: true, userIdentity: userIdentity };
                }

                // å°è¯•è·å–ç”¨æˆ·èº«ä»½
                const authResult = await cloudKit.setUpAuth();
                if (authResult === 'development' || authResult === 'production') {
                    const currentUser = cloudKit.currentUserIdentity;
                    if (currentUser) {
                        return { authenticated: true, userIdentity: currentUser };
                    }
                }

                return { authenticated: false, needsSignIn: true };
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·è®¤è¯å¤±è´¥:', error);
                return { authenticated: false, error: error.message };
            }
        }

        // æ›´æ–°ç”¨æˆ·è®¤è¯UI
        function updateUserAuthUI(userIdentity) {
            const userInfo = document.getElementById('userInfo');
            
            if (userIdentity) {
                // å·²ç™»å½•ï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                if (userInfo) {
                    userInfo.style.display = 'inline';
                    userInfo.textContent = `Apple ID: ${userIdentity.nameComponents?.givenName || userIdentity.userRecordName || 'å·²ç™»å½•'}`;
                }
            } else {
                // æœªç™»å½•ï¼Œéšè—ç”¨æˆ·ä¿¡æ¯
                if (userInfo) userInfo.style.display = 'none';
            }
        }

        // ä»ç™»å½•é¡µé¢å¤„ç† Apple ID ç™»å½•
        async function handleAppleSignInFromLogin() {
            const statusDiv = document.getElementById('appleLoginStatus');
            const loginBtn = document.getElementById('appleSignInBtnLogin');
            
            // å¦‚æœ CloudKit æœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–
            if (!cloudKit) {
                if (statusDiv) statusDiv.innerHTML = '<span style="color: #ffc107;">æ­£åœ¨åˆå§‹åŒ– CloudKit...</span>';
                await initCloudKitForAuthOnly();
                if (!cloudKit) {
                    if (statusDiv) statusDiv.innerHTML = '<span style="color: #dc3545;">CloudKit åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</span>';
                    return;
                }
            }

            if (statusDiv) {
                statusDiv.innerHTML = '<span style="color: #ffc107;">æ­£åœ¨è¿æ¥ Apple ç™»å½•æœåŠ¡...</span>';
            }
            if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.textContent = 'æ­£åœ¨è¿æ¥...';
            }

            try {
                // å°è¯•è§¦å‘ç™»å½•æµç¨‹
                const authResult = await cloudKit.setUpAuth();
                console.log('Apple ç™»å½•ç»“æœ:', authResult);
                
                // å¦‚æœè¿”å›çš„æ˜¯é‡å®šå‘URLï¼Œè¯´æ˜éœ€è¦è·³è½¬åˆ°ç™»å½•é¡µé¢
                if (typeof authResult === 'string' && authResult.startsWith('http')) {
                    if (statusDiv) {
                        statusDiv.innerHTML = '<span style="color: #ffc107;">æ­£åœ¨è·³è½¬åˆ° Apple ç™»å½•é¡µé¢...</span>';
                    }
                    // ä¿å­˜å½“å‰é¡µé¢URLï¼Œç™»å½•åå¯ä»¥è¿”å›
                    sessionStorage.setItem('returnUrl', window.location.href);
                    sessionStorage.setItem('appleLoginInProgress', 'true');
                    // å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°æç¤º
                    setTimeout(() => {
                        window.location.href = authResult;
                    }, 500);
                    return;
                }

                // æ£€æŸ¥ç™»å½•åçš„ç”¨æˆ·èº«ä»½
                const userIdentity = cloudKit.currentUserIdentity;
                if (userIdentity) {
                    if (statusDiv) {
                        statusDiv.innerHTML = '<span style="color: #28a745;">âœ“ Apple ID ç™»å½•æˆåŠŸï¼</span>';
                    }
                    if (loginBtn) {
                        loginBtn.textContent = 'âœ“ å·²ç™»å½•';
                        loginBtn.style.background = '#28a745';
                    }
                    // æ›´æ–°è¿æ¥çŠ¶æ€ï¼ˆå¦‚æœä¸»é¡µé¢å·²åŠ è½½ï¼‰
                    const connectionStatus = document.getElementById('connectionStatus');
                    if (connectionStatus) {
                        connectionStatus.textContent = `âœ“ å·²è¿æ¥åˆ° CloudKit (ç”¨æˆ·: ${userIdentity.nameComponents?.givenName || 'å·²ç™»å½•'})`;
                    }
                } else {
                    if (statusDiv) {
                        statusDiv.innerHTML = '<span style="color: #dc3545;">ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•</span>';
                    }
                    if (loginBtn) {
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'ğŸ ä½¿ç”¨ Apple ID ç™»å½•';
                    }
                }
            } catch (error) {
                console.error('Apple ID ç™»å½•å¤±è´¥:', error);
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color: #dc3545;">ç™»å½•å¤±è´¥: ' + (error.message || error) + '</span>';
                }
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'ğŸ ä½¿ç”¨ Apple ID ç™»å½•';
                }
            }
        }

        // å¤„ç† Apple ID ç™»å½•ï¼ˆä»ä¸»é¡µé¢è°ƒç”¨ï¼Œå·²åºŸå¼ƒï¼Œä¿ç•™ä»¥å…¼å®¹ï¼‰
        async function handleAppleSignIn() {
            // è¿™ä¸ªå‡½æ•°ç°åœ¨ä¸å†ä½¿ç”¨ï¼Œå› ä¸ºç™»å½•æŒ‰é’®å·²ç§»åˆ°ç™»å½•é¡µé¢
            console.warn('handleAppleSignIn å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ç™»å½•é¡µé¢çš„ Apple ID ç™»å½•åŠŸèƒ½');
        }

        // æ˜¾ç¤ºç™»å½•æç¤ºå¹¶å°è¯•ç™»å½•
        async function promptUserSignIn() {
            if (!cloudKit) {
                alert('CloudKit æœªåˆå§‹åŒ–ï¼Œæ— æ³•ç™»å½•');
                return false;
            }

            const confirmed = confirm('ä¿å­˜æ“ä½œéœ€è¦ç™»å½• Apple IDã€‚\n\næ˜¯å¦ç°åœ¨ç™»å½•ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"åï¼Œå°†è¿”å›ç™»å½•é¡µé¢è¿›è¡Œ Apple ID ç™»å½•ã€‚');
            if (!confirmed) {
                return false;
            }

            // è¿”å›ç™»å½•é¡µé¢
            handleLogout();
            // æ˜¾ç¤ºæç¤ºï¼Œå¼•å¯¼ç”¨æˆ·ä½¿ç”¨ç™»å½•é¡µé¢çš„ Apple ID ç™»å½•æŒ‰é’®
            setTimeout(() => {
                alert('è¯·åœ¨ç™»å½•é¡µé¢ç‚¹å‡»"ä½¿ç”¨ Apple ID ç™»å½•"æŒ‰é’®å®Œæˆç™»å½•ã€‚');
            }, 500);
            
            return false;
        }

        // ä¿å­˜é¢„å‡ºåº“æ–¹æ¡ˆ
        async function savePreOutboundDesign(event) {
            event.preventDefault();

            const name = document.getElementById('designName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥æ–¹æ¡ˆåç§°');
                return;
            }

            if (selectedItemsForDesign.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç‰©å“');
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
            const authCheck = await checkUserAuth();
            if (!authCheck.authenticated) {
                const shouldSignIn = await promptUserSignIn();
                if (!shouldSignIn) {
                    return; // ç”¨æˆ·å–æ¶ˆç™»å½•æˆ–ç™»å½•å¤±è´¥
                }
                // é‡æ–°æ£€æŸ¥è®¤è¯çŠ¶æ€
                const recheck = await checkUserAuth();
                if (!recheck.authenticated) {
                    alert('éœ€è¦ç™»å½• Apple ID æ‰èƒ½ä¿å­˜æ•°æ®ã€‚è¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚');
                    return;
                }
            }

            try {
                // å‡†å¤‡æ•°æ®
                const creator = document.getElementById('designCreator').value.trim() || 'admin';
                const eventInfo = document.getElementById('designEventInfo').value.trim() || '';
                const eventLocation = document.getElementById('designEventLocation').value.trim() || '';
                
                const startDateInput = document.getElementById('designEventStartDate').value;
                const endDateInput = document.getElementById('designEventEndDate').value;
                
                const startDate = startDateInput ? new Date(startDateInput) : new Date();
                const endDate = endDateInput ? new Date(endDateInput) : new Date();
                const designDate = new Date();

                // å°†é€‰ä¸­çš„ç‰©å“è½¬æ¢ä¸º items æ•°ç»„æ ¼å¼
                const itemsArray = selectedItemsForDesign.map(item => ({
                    barcode: item.barcode,
                    name: item.name || '',
                    brand: item.brand || '',
                    model: item.model || '',
                    serialNumber: item.serialNumber || ''
                }));

                // ç”Ÿæˆæ¡ç 
                const barcode = `P${new Date().toISOString().replace(/[-:T]/g, '').split('.')[0]}`;

                // åˆ›å»º CloudKit è®°å½•å¯¹è±¡
                const record = {
                    recordType: 'PreOutboundDesign',
                    fields: {
                        name: { value: name },
                        creator: { value: creator },
                        eventInfo: { value: eventInfo },
                        eventLocation: { value: eventLocation },
                        eventStartDate: { value: startDate },
                        eventEndDate: { value: endDate },
                        designDate: { value: designDate },
                        items: { value: JSON.stringify(itemsArray) },
                        barcode: { value: barcode }
                    }
                };

                // ä½¿ç”¨ CloudKit JS API ä¿å­˜è®°å½•
                const response = await cloudKit.publicCloudDatabase.saveRecords([record]);

                if (response.hasErrors && response.errors.length > 0) {
                    throw new Error(response.errors[0].message || 'ä¿å­˜å¤±è´¥');
                }

                alert('é¢„å‡ºåº“æ–¹æ¡ˆåˆ›å»ºæˆåŠŸï¼');
                closeCreatePreOutboundModal();
                
                // åˆ·æ–°é¢„å‡ºåº“æ–¹æ¡ˆåˆ—è¡¨
                await loadPreOutboundDesigns();

            } catch (error) {
                console.error('ä¿å­˜é¢„å‡ºåº“æ–¹æ¡ˆå¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + (error.message || error));
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–ä¸»é¢˜
            try {
                const savedTheme = localStorage.getItem('proinventory-theme') || 'light';
                setTheme(savedTheme);
            } catch (e) {}
            const themeCheckbox = document.getElementById('themeCheckbox');
            const themeLabel = document.getElementById('themeLabel');
            if (themeCheckbox) {
                themeCheckbox.addEventListener('change', () => {
                    const mode = themeCheckbox.checked ? 'dark' : 'light';
                    setTheme(mode);
                    try { localStorage.setItem('proinventory-theme', mode); } catch (e) {}
                    if (themeLabel) themeLabel.textContent = mode === 'dark' ? 'æš—è‰²' : 'äº®è‰²';
                });
            }
            // å¦‚æœå·²ç™»å½•ï¼Œåˆå§‹åŒ– CloudKit
            const isLoggedIn = localStorage.getItem(LOGIN_STORAGE_KEY) === 'true';
            if (isLoggedIn) {
                initCloudKit();
            }
        });

        function setTheme(mode) {
            const root = document.body;
            const themeCheckbox = document.getElementById('themeCheckbox');
            const themeLabel = document.getElementById('themeLabel');
            if (mode === 'dark') {
                root.classList.add('dark-theme');
                if (themeCheckbox) themeCheckbox.checked = true;
                if (themeLabel) themeLabel.textContent = 'æš—è‰²';
            } else {
                root.classList.remove('dark-theme');
                if (themeCheckbox) themeCheckbox.checked = false;
                if (themeLabel) themeLabel.textContent = 'äº®è‰²';
            }
        }
    </script>
</body>
</html>

